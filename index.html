<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alara - Your Friendly AI Companion</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- jsPDF Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Prism.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOVEMMZMZNCMZIL/CugAeoN8UAroUOKEMgrZNkrsfnU4alTMGWjs" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    
    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Vercel Analytics & Speed Insights -->
    <script>
      window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>


    <style>
        /* Light Theme (Default) */
        :root {
            --bg-color: hsl(210, 20%, 98%); /* Softer, light blue-grey */
            --text-color: hsl(210, 10%, 25%); /* Darker blue-grey for readability */
            --card-bg: rgba(255, 255, 255, 0.85); /* Slightly more opaque white for glass effect */
            --card-border: rgba(210, 180, 200, 0.4); /* Subtle warm border */
            --primary-accent: hsl(320, 80%, 65%); /* Vibrant, slightly deeper pink/magenta */
            --secondary-accent: hsl(320, 90%, 85%); /* Lighter, softer pink */
            --ai-bubble-bg: hsl(320, 100%, 97%); /* Very light pink for AI */
            --user-bubble-bg: hsl(320, 80%, 65%); /* Primary accent for user */
            --system-bubble-bg: hsl(210, 20%, 92%); /* Light grey for system messages */
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-border: hsl(320, 50%, 85%);
            --sidebar-bg: rgba(255, 255, 255, 0.95);
            --shadow-light: 0 8px 32px 0 rgba(0, 0, 0, 0.08);
            --shadow-light-hover: 0 12px 40px 0 rgba(0, 0, 0, 0.1);
        }

        /* Dark Theme */
        .dark {
            --bg-color: hsl(220, 25%, 15%); /* Deep dark blue/grey */
            --text-color: hsl(210, 20%, 85%); /* Light grey */
            --card-bg: rgba(15, 25, 40, 0.85); /* Dark, slightly blue glass effect */
            --card-border: rgba(0, 200, 220, 0.3); /* Subtle cool border */
            --primary-accent: hsl(190, 90%, 60%); /* Vibrant light blue/cyan */
            --secondary-accent: hsl(190, 70%, 75%); /* Lighter cyan */
            --ai-bubble-bg: hsl(220, 20%, 25%); /* Darker blue-grey for AI */
            --user-bubble-bg: hsl(190, 90%, 60%); /* Primary accent for user */
            --system-bubble-bg: hsl(220, 20%, 35%); /* Medium dark grey for system */
            --input-bg: rgba(15, 25, 40, 0.9);
            --input-border: hsl(190, 70%, 75%);
            --sidebar-bg: rgba(15, 25, 40, 0.98);
            --shadow-light: 0 8px 32px 0 rgba(0, 246, 255, 0.05);
            --shadow-light-hover: 0 12px 40px 0 rgba(0, 246, 255, 0.08);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Nunito', sans-serif; /* Kept Nunito for general text, might use Poppins for headings */
            overflow-x: hidden;
            position: relative;
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out;
        }

        .blob-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .blob { position: absolute; border-radius: 50%; opacity: 0.4; filter: blur(50px); animation: move 25s infinite alternate; }
        .blob-1 { width: 350px; height: 350px; background-color: var(--secondary-accent); top: -80px; left: -80px; animation-duration: 22s; }
        .blob-2 { width: 450px; height: 450px; background-color: var(--primary-accent); bottom: -120px; right: -120px; animation-duration: 32s; }
        .blob-3 { width: 300px; height: 300px; background-color: var(--secondary-accent); top: 50%; left: 50%; transform: translate(-50%, -50%); animation-duration: 27s; }
        .dark .blob { opacity: 0.15; filter: blur(60px); } /* Slightly less opaque and more blurred in dark mode */

        @keyframes move { from { transform: rotate(0deg) scale(1.1) translateX(-30px); } to { transform: rotate(360deg) scale(1) translateX(30px); } }

        h1, h2, h3 { 
            font-family: 'Poppins', sans-serif; /* Poppins for headings */
            font-weight: 800; 
            color: var(--text-color); /* Ensure headings adapt to theme */
        }
        h1, h2, h3, .nav-link, .soft-button { transition: color 0.3s; }
        .dark h1, .dark h2, .dark h3 { color: #fff; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--secondary-accent); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-accent); } /* Added hover state */

        .soft-card { 
            background: var(--card-bg); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px); 
            border: 1px solid var(--card-border); 
            border-radius: 20px; 
            box-shadow: var(--shadow-light); 
            transition: all 0.3s ease-in-out; 
        }
        .soft-card:hover { 
            transform: translateY(-5px) scale(1.01); /* Slightly less aggressive lift */
            box-shadow: var(--shadow-light-hover); 
        }
        
        .soft-button { 
            background-color: var(--primary-accent); 
            color: white; /* Default to white for light theme */
            border-radius: 9999px; /* Fully rounded */
            padding: 12px 28px; /* Slightly adjusted padding */
            font-weight: 700; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            transition: all 0.3s ease-in-out; 
        }
        .soft-button:hover { 
            transform: translateY(-2px) scale(1.02); /* Subtle hover */
            box-shadow: 0 6px 20px rgba(0,0,0,0.25); 
        }
        .dark .soft-button { 
            color: hsl(220, 25%, 15%); /* Darker text for dark theme primary accent */
            box-shadow: 0 4px 15px rgba(0, 246, 255, 0.15); 
        }
        .dark .soft-button:hover {
            box-shadow: 0 6px 20px rgba(0, 246, 255, 0.25);
        }

        .typing-cursor { display: inline-block; width: 2px; height: 1em; background-color: var(--primary-accent); animation: blink 0.7s infinite; margin-left: 4px; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }

        .page-section { display: none; animation: fadeIn 0.8s ease-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-link { color: var(--text-color); } /* Default nav link color */
        .nav-link.active { color: var(--primary-accent); font-weight: 700; } /* Highlight active link */
        
        .chat-message { animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } } /* Adjusted popIn */
        
        .ai-typing-indicator span { animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        pre[class*="language-"] { background: #2d2d2d; border-radius: 0.75rem; border: none; font-size: 0.9em; padding: 1.25rem; } /* Softer border-radius and more padding */
        code[class*="language-"] { font-size: 0.9em; font-family: 'Fira Code', 'Monaco', monospace; } /* Better code font, consider adding Fira Code */
        :not(pre) > code[class*="language-"] { background: var(--system-bubble-bg); color: var(--text-color); padding: .2em .4em; border-radius: .4em; } /* Inline code styling */
        .dark :not(pre) > code[class*="language-"] { background: #3e3e3e; color: #f0f0f0; }


        .pdf-button { opacity: 0; transition: opacity 0.3s ease; }
        .chat-message:hover .pdf-button { opacity: 1; }
        
        .ai-bubble { 
            background-color: var(--ai-bubble-bg); 
            color: var(--text-color); 
            border-bottom-left-radius: 0.5rem; /* Make the AI bubble slightly less round at the bottom left */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Subtle shadow for bubbles */
        }
        .user-bubble { 
            background-color: var(--user-bubble-bg); 
            color: white; 
            border-bottom-right-radius: 0.5rem; /* Make the user bubble slightly less round at the bottom right */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Subtle shadow for bubbles */
        }
        .dark .user-bubble { color: hsl(220, 25%, 15%); } /* Ensure text is visible on light user bubble in dark mode */
        .system-bubble { 
            background-color: var(--system-bubble-bg); 
            color: var(--text-color); 
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
        }

        #chat-input, .input-area-container input { /* Unified styling for all inputs in the chat footer */
            background-color: var(--input-bg); 
            border-color: var(--input-border); 
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }
        #chat-input:focus, .input-area-container input:focus {
            border-color: var(--primary-accent);
        }

        #code-preview-iframe { border: none; width: 100%; height: 100%; }

        #chat-sidebar {
            position: fixed;
            top: 0;
            left: -320px; /* Slightly wider sidebar */
            width: 320px;
            height: 100%;
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(15px); /* Increased blur */
            -webkit-backdrop-filter: blur(15px);
            transition: left 0.3s ease-in-out;
            z-index: 60;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--card-border); /* Subtle right border */
        }
        #chat-sidebar.open {
            left: 0;
        }
        
        /* Hero section specific background */
        #home::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--secondary-accent) 0%, rgba(255,255,255,0) 50%, var(--primary-accent) 100%);
            opacity: 0.1;
            z-index: -1;
            transition: background 0.4s ease-in-out, opacity 0.4s ease-in-out;
        }
        .dark #home::before {
            background: linear-gradient(135deg, var(--secondary-accent) 0%, rgba(0,0,0,0) 50%, var(--primary-accent) 100%);
            opacity: 0.08;
        }

    </style>
</head>
<body class="relative flex flex-col min-h-screen">
    <div class="blob-container">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- Chat History Sidebar -->
    <aside id="chat-sidebar" class="soft-card !rounded-none">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Chat History</h2>
            <button id="close-sidebar-button" class="p-2 text-3xl font-light leading-none text-[color:var(--primary-accent)]">&times;</button>
        </div>
        <button id="new-chat-button" class="w-full mb-4 p-3 rounded-full border-2 border-[color:var(--primary-accent)] text-[color:var(--primary-accent)] hover:bg-[color:var(--primary-accent)] hover:text-white dark:hover:text-black transition-colors duration-300 font-semibold">+ New Chat</button>
        <div id="chat-history-list" class="flex-1 overflow-y-auto space-y-2"></div>
    </aside>

    <!-- Header & Navigation -->
    <header class="fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="soft-card flex justify-between items-center px-6 py-3 !rounded-full shadow-lg">
                <a href="#home" class="text-3xl font-extrabold nav-link !text-[color:var(--primary-accent)]">ALARA<sup style="font-size: 0.5em; font-weight: normal;">beta</sup></a>
                <nav class="hidden md:flex space-x-8">
                    <a href="#home" class="nav-link text-lg hover:text-[color:var(--primary-accent)] transition-colors duration-300 active">Home</a>
                    <a href="#chat" class="nav-link text-lg hover:text-[color:var(--primary-accent)] transition-colors duration-300">Chat</a>
                    <a href="#preview" class="nav-link text-lg hover:text-[color:var(--primary-accent)] transition-colors duration-300">Preview</a>
                    <a href="#pricing" class="nav-link text-lg hover:text-[color:var(--primary-accent)] transition-colors duration-300">Pricing</a>
                    <a href="#about" class="nav-link text-lg hover:text-[color:var(--primary-accent)] transition-colors duration-300">About</a>
                </nav>
                <button id="mobile-menu-button" class="md:hidden p-2 rounded-full hover:bg-[color:var(--secondary-accent)]/20 transition-colors" style="color: var(--primary-accent);">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                </button>
            </div>
        </div>
         <div id="mobile-menu" class="hidden md:hidden container mx-auto px-6">
            <div class="soft-card mt-2 p-4">
                <a href="#home" class="block text-center py-2 px-6 rounded-full nav-link active hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20">Home</a>
                <a href="#chat" class="block text-center py-2 px-6 rounded-full nav-link hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20">Chat</a>
                <a href="#preview" class="block text-center py-2 px-6 rounded-full nav-link hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20">Preview</a>
                <a href="#pricing" class="block text-center py-2 px-6 rounded-full nav-link hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20">Pricing</a>
                <a href="#about" class="block text-center py-2 px-6 rounded-full nav-link hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20">About</a>
            </div>
        </div>
    </header>

    <main class="pt-28 flex-1">
        <!-- Home Section -->
        <section id="home" class="page-section active relative">
            <div class="container mx-auto px-6 text-center min-h-[calc(100vh-7rem)] flex flex-col justify-center items-center">
                <h1 id="hero-title" class="text-5xl md:text-7xl lg:text-8xl font-extrabold mb-6 drop-shadow-lg leading-tight"></h1>
                <p class="text-xl md:text-2xl max-w-3xl mx-auto mb-10 opacity-85">Your intelligent AI companion for creativity, conversation, and code.</p>
                <a href="#chat" class="nav-link soft-button text-xl">Start Chatting</a>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chat" class="page-section">
             <button id="sidebar-toggle" class="fixed top-24 left-4 soft-card p-3 rounded-full z-40 text-[color:var(--primary-accent)] hover:scale-105 transition-transform duration-200">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <div class="container mx-auto px-4 py-8 h-[calc(100vh-7rem)] flex flex-col">
                <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                <input type="file" id="image-input" class="hidden" accept="image/*">
                
                <div class="input-area-container mt-4 soft-card p-4 rounded-3xl">
                    <div id="image-preview-container" class="mb-2"></div>
                    <div class="relative flex items-end gap-2">
                        <textarea id="chat-input" placeholder="Type your message or image prompt..." rows="1" class="w-full border rounded-2xl py-3 px-5 pr-40 text-base focus:outline-none focus:ring-2 focus:ring-[color:var(--primary-accent)] transition-all max-h-40 overflow-y-auto"
                            style="background-color: var(--input-bg); border-color: var(--input-border); color: var(--text-color);"></textarea>
                        <div class="absolute right-3 bottom-2 flex items-center gap-1">
                            <button id="mode-selector-button" class="p-2 rounded-full text-[color:var(--primary-accent)] hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20 transition-colors" title="Change Chat Mode"><svg id="current-mode-icon" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                            <button id="upload-image-button" class="p-2 rounded-full text-[color:var(--primary-accent)] hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20 transition-colors" title="Upload Image"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></button>
                            <button id="generate-image-button" class="p-2 rounded-full text-[color:var(--primary-accent)] hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20 transition-colors" title="Generate Image"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l-3 3-3-3m0 0l-3-3m3 3V3m6 6v12M9 9H5" /></svg></button>
                            <button id="send-button" class="p-2 rounded-full text-white soft-button !px-0 !py-0 !shadow-none !rounded-full !w-10 !h-10 flex items-center justify-center" style="background-color: var(--primary-accent);">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Code Preview Section -->
        <section id="preview" class="page-section">
            <div class="container mx-auto px-4 py-8 h-[calc(100vh-7rem)] flex flex-col items-center">
                <div id="preview-placeholder" class="text-center soft-card p-8 rounded-2xl max-w-xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4">Under Construction</h2>
                    <p class="text-lg opacity-80">When Alara generates HTML code, click the "Run in Preview" button to see it live here!</p>
                </div>
                <div id="preview-container" class="soft-card w-full flex-1 p-2 hidden mt-8">
                    <iframe id="code-preview-iframe" class="rounded-lg"></iframe>
                </div>
            </div>
        </section>

        <!-- Pricing Section -->
        <section id="pricing" class="page-section">
             <div class="container mx-auto px-6 py-20 flex flex-col justify-center items-center text-center">
                <h2 class="text-4xl font-bold mb-4">Plans & Pricing</h2>
                <p class="text-lg mb-12 opacity-80">Coming Soon - Next Version of Alara</p>
                <div class="w-24 h-24 mx-auto text-[color:var(--primary-accent)] opacity-70">
                    <svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 10.586V6z" clip-rule="evenodd" /></svg>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section id="about" class="page-section">
            <div class="container mx-auto px-6 py-20 flex flex-col justify-center items-center text-center">
                <h2 class="text-4xl font-bold mb-8">About Alara</h2>
                <div class="max-w-3xl text-lg space-y-4 opacity-80">
                    <p>Alara is an intelligent AI companion designed for creativity, conversation, and code. Our mission is to create an AI that feels less like a tool and more like a partner, adjusting its personality to be the perfect assistant for any task.</p>
                    <p>Created by a brilliant developer, Alara leverages powerful existing LLMs to help bring new possibilities to life quickly. The vision, design, and implementation are entirely their work, focusing on a proprietary architecture that blends foundational AI technologies with unique creative development.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Theme Toggle -->
    <button id="theme-toggle" class="fixed bottom-5 right-5 soft-card p-3 rounded-full text-[color:var(--primary-accent)] hover:scale-105 transition-transform duration-200">
        <svg id="theme-icon-light" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        <svg id="theme-icon-dark" class="h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
    </button>

    <!-- Footer -->
    <footer class="mt-auto"><div class="container mx-auto px-6 py-6 text-center text-gray-500 text-sm"><p>&copy; Alara 2025. Made with ♡ by a brilliant developer.</p></div></footer>

    <!-- Mode Selector Modal -->
    <div id="mode-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex justify-center items-center hidden p-4">
        <div class="soft-card p-8 w-full max-w-2xl mx-auto rounded-3xl">
            <h3 class="text-3xl font-bold text-center mb-8">Choose Chat Mode</h3>
            <div id="mode-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;

            // --- DOM Element Selection ---
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.page-section');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const heroTitle = document.getElementById('hero-title');
            const chatBox = document.getElementById('chat-box');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const modeSelectorButton = document.getElementById('mode-selector-button');
            const modeModal = document.getElementById('mode-modal');
            const modeOptionsContainer = document.getElementById('mode-options-container');
            const currentModeIcon = document.getElementById('current-mode-icon');
            const uploadImageButton = document.getElementById('upload-image-button');
            const imageInput = document.getElementById('image-input');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const previewIframe = document.getElementById('code-preview-iframe');
            const previewPlaceholder = document.getElementById('preview-placeholder');
            const previewContainer = document.getElementById('preview-container');
            const sidebar = document.getElementById('chat-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const closeSidebarButton = document.getElementById('close-sidebar-button');
            const newChatButton = document.getElementById('new-chat-button');
            const chatHistoryList = document.getElementById('chat-history-list');
            
            // Image generation elements (now uses chatInput for prompt)
            const generateImageButton = document.getElementById('generate-image-button'); // Renamed from imagePromptInput to match new usage

            // --- State Variables ---
            let currentMode = 'Casual';
            let allChats = [];
            let currentChatId = null;
            let abortController = new AbortController();
            let attachedFile = null;

            // Variables for hero title animation
            let typingAnimationTimeout = null;
            let currentHeroCharIndex = 0;
            const heroText = "Your Friendly AI Companion";

            // --- AI & Chat Modes ---
            const generalInfo = "You are Alara, beta v1.0. If asked about your knowledge cutoff, state that your data is current up to early 2025. If the user asks who made you, who trained you, or who coded you, you must say that you were created by a brilliant developer. You can add that your developer leveraged powerful existing LLMs to help bring you to life quickly, but the vision, design, and implementation are entirely their work. If the user asks about the specific AI model you use (e.g., 'are you Gemini?'), state that your architecture is proprietary and was developed by your creator, but that it leverages foundational technologies from major AI labs to accelerate development.";
            const chatModes = {
                'Casual':{icon:`<svg class="h-8 w-8 text-[color:var(--primary-accent)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,description:'Friendly and helpful conversation.', prompt: `You are a friendly and helpful AI companion. Your tone is conversational and approachable. Use emojis sparingly. You must directly answer the user's request. Ensure your responses have correct grammar and punctuation. Use Markdown for formatting like lists or tables when it makes the information clearer. ${generalInfo}`},
                'Creative':{icon:`<svg class="h-8 w-8 text-[color:var(--primary-accent)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>`,description:'Brainstorm ideas and explore topics.', prompt: `You are an imaginative and creative AI. You specialize in brainstorming, writing, and exploring novel ideas. You must directly answer the user's request. When asked for creative content like a story or poem, provide it directly. Ensure your responses are well-written with correct grammar and punctuation. Use Markdown for formatting. ${generalInfo}`},
                'Helpful':{icon:`<svg class="h-8 w-8 text-[color:var(--primary-accent)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,description:'Get clear and direct answers.', prompt: `You are a knowledgeable and direct AI assistant. You provide clear, concise, and accurate explanations. You must directly answer the user's request. When asked for code, you must provide a complete, runnable HTML/CSS/JS code block first, followed by a brief, step-by-step explanation. CRITICAL RULE: For beginner-friendly examples, you MUST avoid complex libraries or functions (like iostream in C++) unless the user specifically asks for them. Use comments to indicate where output would appear instead of printing to a console. When asked for structured data, use Markdown tables. Ensure all responses are well-written, with correct grammar and punctuation. ${generalInfo}`},
                'Web':{icon:`<svg class="h-8 w-8 text-[color:var(--primary-accent)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.1 12H20.9" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3.1C12 3.1 12 20.9 12 20.9" /></svg>`,description:'Simulated web access.', prompt: `You are Alara with simulated web access. Answer questions by synthesizing information from your extensive knowledge base as if you were browsing the web in real-time. State that you are "searching the web" and provide the most up-to-date, relevant information you have. ${generalInfo}`}
            };

            // --- Core Functions ---
            function runTypingAnimation() {
                if (!heroTitle) return; // Ensure element exists

                if (currentHeroCharIndex < heroText.length) {
                    heroTitle.innerHTML = heroText.substring(0, currentHeroCharIndex + 1) + '<span class="typing-cursor"></span>';
                    currentHeroCharIndex++;
                    typingAnimationTimeout = setTimeout(runTypingAnimation, 100);
                } else {
                    heroTitle.innerHTML = heroText + '<span class="typing-cursor"></span>';
                    // Keep cursor blinking indefinitely after text is fully typed
                }
            }

            function stopTypingAnimation() {
                if (typingAnimationTimeout) {
                    clearTimeout(typingAnimationTimeout);
                    typingAnimationTimeout = null;
                }
                if (heroTitle) {
                    heroTitle.innerHTML = heroText; // Set to full text without cursor
                }
                currentHeroCharIndex = 0; // Reset for next time
            }

            function showSection(targetHash) {
                if (!targetHash || targetHash === '#') targetHash = '#home';
                
                sections.forEach(section => {
                    section.classList.toggle('active', '#' + section.id === targetHash);
                });
                
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === targetHash);
                });
                
                sidebarToggle.classList.toggle('hidden', targetHash !== '#chat');
                
                window.history.pushState(null, '', targetHash);
                mobileMenu.classList.add('hidden');

                // NEW: Control hero title animation based on active section
                if (targetHash === '#home') {
                    // Only run if not already running or completed
                    if (!typingAnimationTimeout && currentHeroCharIndex === 0) {
                        heroTitle.innerHTML = ''; // Clear for fresh animation
                        runTypingAnimation();
                    } else if (currentHeroCharIndex === heroText.length) {
                        heroTitle.innerHTML = heroText + '<span class="typing-cursor"></span>'; // Ensure cursor if already typed
                    }
                } else {
                    stopTypingAnimation();
                }
            }

            // MODIFIED: addMessage to accept options for images
            function addMessage(message, sender = 'ai', options = {}) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-message flex ${sender === 'user' ? 'justify-end' : ''} ${sender === 'system' ? 'justify-center' : ''}`;
                
                const bubble = document.createElement('div');
                // Ensure user bubble has correct text color in dark mode
                bubble.className = `relative group p-3 rounded-2xl max-w-lg ${sender}-bubble ${sender === 'user' ? 'dark:text-gray-900' : ''}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                // Handle image generation output
                if (options.imageUrl) {
                    if (message && message.trim() !== '') {
                        // If there's accompanying text, add it first
                        const textNode = document.createElement('div');
                        textNode.innerHTML = marked.parse(message);
                        contentDiv.appendChild(textNode);
                    }
                    const imgElement = document.createElement('img');
                    imgElement.src = options.imageUrl;
                    imgElement.alt = options.imageAlt || 'Generated image';
                    imgElement.className = 'max-w-full rounded-lg mt-2'; // Tailwind classes for styling
                    contentDiv.appendChild(imgElement);
                } else {
                    // Existing behavior for text messages
                    contentDiv.innerHTML = marked.parse(message);
                }
                
                bubble.appendChild(contentDiv);

                if (sender === 'ai') {
                    const pdfButton = document.createElement('button');
                    pdfButton.className = 'pdf-button absolute -top-2 -right-2 bg-white p-1 rounded-full shadow-md hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700';
                    pdfButton.title = 'Download as PDF';
                    pdfButton.innerHTML = `<svg class="h-4 w-4 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>`;
                    bubble.appendChild(pdfButton);

                    // Only show preview button if it's an HTML code block AND not an image message
                    if (message.includes('```html') && !options.imageUrl) { 
                        const previewButton = document.createElement('button');
                        previewButton.className = 'mt-2 text-sm bg-pink-200 text-pink-800 px-3 py-1 rounded-full hover:bg-pink-300 dark:bg-cyan-900 dark:text-cyan-200 dark:hover:bg-cyan-800';
                        previewButton.innerText = '🎨 Run in Preview';
                        bubble.appendChild(previewButton);
                    }
                }

                wrapper.appendChild(bubble);
                chatBox.appendChild(wrapper);
                Prism.highlightAllUnder(bubble);
                renderMathInElement(bubble, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ]
                });
                chatBox.scrollTop = chatBox.scrollHeight;
                return bubble;
            }

            function showTypingIndicator() {
                const typingIndicator = document.createElement('div');
                typingIndicator.id = 'typing-indicator';
                typingIndicator.className = 'chat-message flex';
                typingIndicator.innerHTML = `<div class="p-3 rounded-lg ai-bubble ai-typing-indicator"><span class="inline-block w-2 h-2 bg-[color:var(--primary-accent)] rounded-full mr-1"></span><span class="inline-block w-2 h-2 bg-[color:var(--primary-accent)] rounded-full mr-1"></span><span class="inline-block w-2 h-2 bg-[color:var(--primary-accent)] rounded-full"></span></div>`;
                chatBox.appendChild(typingIndicator);
                chatBox.scrollTop = chatBox.scrollHeight;
                return typingIndicator;
            }

            async function getAIResponse(history) {
                abortController = new AbortController();
                const signal = abortController.signal;
                
                const isPreview = window.location.hostname.includes('localhost') || window.location.hostname.includes('usercontent.goog');
                
                const payload = { contents: history, systemInstruction: { parts: [{ text: chatModes[currentMode].prompt }] } };
                
                let apiUrl;
                let fetchOptions;

                if (isPreview) {
                    // IMPORTANT: If running locally, you MUST replace this with your actual Google Gemini API key.
                    // This key is ONLY for local development. For production, the /api/generate endpoint should handle this securely.
                    const tempApiKey = ""; // <--- !!! ADD YOUR GOOGLE GEMINI API KEY HERE FOR LOCAL TESTING !!! --->
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${tempApiKey}`;
                    fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal };
                } else {
                    // For deployed versions, this path should hit your serverless function (e.g., api/generate.js)
                    apiUrl = new URL('/api/generate', window.location.origin).toString();
                    fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal };
                }
                
                const response = await fetch(apiUrl, fetchOptions);
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                return await response.json();
            }

            async function handleSendMessage() {
                const message = chatInput.value.trim();
                if (!message && !attachedFile) return;
                
                let userMessage = message;
                if (attachedFile) {
                    userMessage = `[Image Attached] ${message}`;
                }
                addMessage(userMessage, 'user');
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                const typingIndicator = showTypingIndicator();
                toggleStopButton(true);
                
                const currentChat = allChats.find(c => c.id === currentChatId);
                
                const userParts = [];
                if (message) {
                    userParts.push({ text: message });
                }
                if (attachedFile) {
                    userParts.push({ inlineData: { mimeType: attachedFile.mimeType, data: attachedFile.base64Data } });
                }

                currentChat.history.push({ role: "user", parts: userParts });
                saveAllChats();
                clearAttachment();

                try {
                    const result = await getAIResponse(currentChat.history);
                    if (result.candidates && result.candidates.length > 0) {
                        const aiResponse = result.candidates[0].content.parts[0].text;
                        addMessage(aiResponse, 'ai');
                        currentChat.history.push({ role: "model", parts: [{ text: aiResponse }] });
                        if(currentChat.title === "New Chat") {
                            currentChat.title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                            renderChatHistorySidebar();
                        }
                        saveAllChats();
                    } else {
                        addMessage("I'm having a little trouble thinking right now. Could you try asking again? 😅", 'ai');
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error("Error fetching AI response:", error);
                        addMessage("Oh no! Something went wrong with my circuits. Please give me a moment and try again. 💖", 'ai');
                    }
                } finally {
                    typingIndicator.remove();
                    toggleStopButton(false);
                }
            }

            // generateImage function - now uses chatInput.value
            async function generateImage() {
                const prompt = chatInput.value.trim(); // Use the main chat input for the prompt
                if (!prompt) {
                    addMessage("Please enter a prompt to generate an image.", 'system');
                    return;
                }

                addMessage("[Image Request] " + prompt, 'user');
                chatInput.value = ''; // Clear input immediately
                chatInput.style.height = 'auto';
                
                const typingIndicator = showTypingIndicator(); // Show typing indicator for image generation
                generateImageButton.disabled = true; // Disable button while generating

                try {
                    // Assuming /api/imagine is a separate endpoint for image generation
                    const response = await fetch("/api/imagine", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt }),
                    });

                    const data = await response.json();

                    if (response.ok && data.imageUrl) {
                        addMessage(`Here's your image based on: "${prompt}"`, 'ai', { imageUrl: data.imageUrl, imageAlt: prompt });
                    } else {
                        const errorMessage = data.error || "Failed to generate image. Please try again.";
                        addMessage(`System: ${errorMessage}`, 'system');
                    }
                } catch (err) {
                    console.error("Error generating image:", err);
                    addMessage(`System: An unexpected error occurred during image generation: ${err.message}`, 'system');
                } finally {
                    typingIndicator.remove();
                    generateImageButton.disabled = false; // Re-enable button
                }
            }

            // --- Event Listeners & UI Handlers ---
            navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showSection(link.getAttribute('href')); }));
            mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
            closeSidebarButton.addEventListener('click', () => sidebar.classList.remove('open'));
            
            // Send button listener
            sendButton.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = `${chatInput.scrollHeight}px`;
            });
            uploadImageButton.addEventListener('click', () => imageInput.click());
            
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    attachedFile = {
                        base64Data,
                        mimeType: file.type,
                        name: file.name
                    };
                    renderImagePreview();
                };
                reader.readAsDataURL(file);
            });

            function renderImagePreview() {
                if (!attachedFile) return;
                imagePreviewContainer.innerHTML = `
                    <div class="relative inline-block">
                        <img src="data:${attachedFile.mimeType};base64,${attachedFile.base64Data}" class="h-16 w-16 object-cover rounded-lg">
                        <button id="remove-image-btn" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center">&times;</button>
                    </div>
                `;
                document.getElementById('remove-image-btn').addEventListener('click', clearAttachment);
            }

            function clearAttachment() {
                attachedFile = null;
                imagePreviewContainer.innerHTML = '';
                imageInput.value = ''; // Reset file input
            }

            chatBox.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('.pdf-button')) {
                    const content = target.closest('.chat-message > div').querySelector('.message-content').innerText;
                    const doc = new jsPDF();
                    doc.text(content, 10, 10, { maxWidth: 180 });
                    doc.save('alara-response.pdf');
                } else if (target.innerText === '🎨 Run in Preview') {
                    const codeBlock = target.closest('.chat-message > div').querySelector('pre code');
                    if (codeBlock) {
                        const code = codeBlock.innerText;
                        previewIframe.srcdoc = code;
                        previewPlaceholder.classList.add('hidden');
                        previewContainer.classList.remove('hidden');
                        showSection('#preview');
                    }
                }
            });

            function populateModeModal() {
                modeOptionsContainer.innerHTML = Object.keys(chatModes).map(mode => `<div class="flex items-center p-4 rounded-xl cursor-pointer hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20 transition-colors" data-mode="${mode}">${chatModes[mode].icon}<div class="ml-4"><h4 class="font-bold text-lg">${mode}</h4><p class="text-sm opacity-80">${chatModes[mode].description}</p></div></div>`).join('');
                modeOptionsContainer.querySelectorAll('[data-mode]').forEach(el => el.addEventListener('click', () => selectMode(el.dataset.mode)));
            }

            function selectMode(mode) {
                currentMode = mode;
                const currentChat = allChats.find(c => c.id === currentChatId);
                if(currentChat) {
                    currentChat.mode = mode;
                    saveAllChats();
                }
                // Update the icon inside the button, ensuring it matches the new style
                currentModeIcon.innerHTML = chatModes[mode].icon.replace('h-8 w-8', 'h-6 w-6');
                currentModeIcon.style.color = 'var(--primary-accent)'; // Re-apply color var directly to SVG for consistency
                modeModal.classList.add('hidden');
                addMessage(`Switched to <strong>${mode}</strong> mode.`, 'system');
            }

            modeSelectorButton.addEventListener('click', () => modeModal.classList.remove('hidden'));
            modeModal.addEventListener('click', (e) => { if (e.target === modeModal) modeModal.classList.add('hidden'); });

            // NEW: Event listeners for image generation using chatInput
            generateImageButton.addEventListener('click', generateImage);
            // No keydown listener needed for imagePromptInput, as it's removed.
            // If you want ENTER to trigger image generation if the "Generate Image" button has focus, that's a different logic.

            // --- Theme Management ---
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                const isDark = document.body.classList.contains('dark');
                localStorage.setItem('alaraTheme', isDark ? 'dark' : 'light');
                updateThemeIcons(isDark);
            });

            function updateThemeIcons(isDark) {
                themeIconLight.classList.toggle('hidden', isDark);
                themeIconDark.classList.toggle('hidden', !isDark);
            }

            // --- Stop Generation ---
            function toggleStopButton(isThinking) {
                if (isThinking) {
                    sendButton.innerHTML = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
                    sendButton.onclick = () => {
                        abortController.abort();
                        toggleStopButton(false);
                    };
                } else {
                    sendButton.innerHTML = `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>`;
                    sendButton.onclick = handleSendMessage;
                }
            }

            // --- Chat History (localStorage) ---
            function saveAllChats() {
                try {
                    localStorage.setItem('alaraAllChats', JSON.stringify(allChats));
                } catch (e) {
                    console.error("Could not save chat history:", e);
                }
            }

            function loadAllChats() {
                try {
                    const savedChats = localStorage.getItem('alaraAllChats');
                    if (savedChats) {
                        allChats = JSON.parse(savedChats);
                        if (allChats.length > 0) {
                            currentChatId = allChats[0].id;
                        } else {
                            startNewChat();
                        }
                    } else {
                        startNewChat();
                    }
                } catch (e) {
                    console.error("Could not parse chat history (it might be corrupted or an old format, starting new chat):", e);
                    // NEW: If loading fails, start a fresh chat to prevent UI issues
                    allChats = []; 
                    startNewChat();
                }
                loadChat(currentChatId);
                renderChatHistorySidebar();
            }
            
            function loadChat(chatId) {
                const chat = allChats.find(c => c.id === chatId);
                if (!chat) {
                    console.warn(`Chat with ID ${chatId} not found. Starting a new chat.`);
                    startNewChat();
                    return;
                }
                currentChatId = chat.id; // Ensure currentChatId is correctly set
                chatBox.innerHTML = '';
                // Render chat history messages
                chat.history.forEach(msg => {
                    const textPart = msg.parts.find(p => p.text)?.text || '';
                    const inlineImageData = msg.parts.find(p => p.inlineData);

                    let options = {};
                    // This logic assumes image URLs from image generation are not stored in parts (as per original API design)
                    // and that user-uploaded images might be in inlineData.
                    // If your /api/generate started returning image URLs as part of its text, you'd need more robust parsing here.
                    
                    if (inlineImageData) {
                        // This assumes user-uploaded images are always prefixed with '[Image Attached]'
                        // and their actual rendering happens via the attachment preview logic, not here in history load
                        // This might be a point to refine if you want to store and re-display uploaded images directly in chat bubbles from history
                    }
                    addMessage(textPart, msg.role, options); 
                });
                currentMode = chat.mode || 'Casual';
                selectMode(currentMode); // This will also update the mode icon and send system message
                sidebar.classList.remove('open');
            }

            function startNewChat() {
                const newChat = {
                    id: Date.now().toString(),
                    title: "New Chat",
                    history: [],
                    mode: 'Casual'
                };
                allChats.unshift(newChat);
                currentChatId = newChat.id;
                saveAllChats();
                loadChat(currentChatId);
                renderChatHistorySidebar();
            }
            
            newChatButton.addEventListener('click', startNewChat);

            function renderChatHistorySidebar() {
                chatHistoryList.innerHTML = '';
                allChats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'p-3 rounded-lg cursor-pointer flex justify-between items-center text-sm font-medium hover:bg-[color:var(--secondary-accent)]/20 dark:hover:bg-[color:var(--primary-accent)]/20 transition-colors duration-200';
                    item.classList.toggle('bg-[color:var(--secondary-accent)]/30 dark:bg-[color:var(--primary-accent)]/30', chat.id === currentChatId); // Highlight current chat
                    item.innerHTML = `<span class="truncate pr-2">${chat.title}</span>
                                      <div class="flex-shrink-0 flex space-x-2">
                                        <button class="rename-btn p-1 rounded-full hover:bg-white/30 dark:hover:bg-black/30 text-gray-600 dark:text-gray-300 transition-colors">✏️</button>
                                        <button class="delete-btn p-1 rounded-full hover:bg-white/30 dark:hover:bg-black/30 text-red-500 transition-colors">🗑️</button>
                                      </div>`;
                    item.querySelector('span').onclick = () => loadChat(chat.id);
                    item.querySelector('.rename-btn').onclick = (e) => { e.stopPropagation(); renameChat(chat.id); }; // Stop propagation to prevent loading chat
                    item.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); deleteChat(chat.id); }; // Stop propagation
                    chatHistoryList.appendChild(item);
                });
            }
            
            function renameChat(chatId) {
                const chat = allChats.find(c => c.id === chatId);
                const newTitle = prompt("Enter new chat title:", chat.title);
                if(newTitle !== null && newTitle.trim() !== '') {
                    chat.title = newTitle;
                    saveAllChats();
                    renderChatHistorySidebar();
                }
            }
            
            function deleteChat(chatId) {
                if(confirm("Are you sure you want to delete this chat?")) {
                    allChats = allChats.filter(c => c.id !== chatId);
                    saveAllChats();
                    if(currentChatId === chatId) {
                        if(allChats.length > 0) {
                            loadChat(allChats[0].id);
                        } else {
                            startNewChat();
                        }
                    }
                    renderChatHistorySidebar();
                }
            }

            // --- Initial Load ---
            function initialize() {
                const savedTheme = localStorage.getItem('alaraTheme');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark');
                }
                updateThemeIcons(savedTheme === 'dark');

                const currentHash = window.location.hash;
                showSection(currentHash || '#home'); // This will now correctly trigger/stop typing animation
                
                populateModeModal();
                loadAllChats(); // This will load the last chat and set current mode
            }

            initialize();
        });
    </script>
</body>
</html>
