<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alara Workspace</title>
    
    <!-- BOOTSTRAP 5 & ICONS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=Poppins:wght@500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- UTILITIES -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <!-- PDF & Math -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
      window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>

    <style>
        :root {
            /* LAYOUT */
            --sidebar-width: 280px;
            
            /* FONTS */
            --font-main: 'Nunito', sans-serif;
            --font-header: 'Poppins', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            
            /* LIGHT THEME */
            --bg-body: #fff0f5; 
            --bg-sidebar: rgba(255, 255, 255, 0.65);
            --bg-card: rgba(255, 255, 255, 0.85);
            --bg-glass: rgba(255, 255, 255, 0.7);
            --text-primary: #4a044e;
            --text-secondary: #86198f;
            
            /* BRAND COLORS (Pink/Rose) */
            --accent: #db2777; 
            --accent-gradient: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            --accent-glow: rgba(236, 72, 153, 0.4);
            --accent-light: #fce7f3;
            
            --border: rgba(255, 255, 255, 0.8);
            --shadow-light: 0 8px 32px 0 rgba(219, 39, 119, 0.07);
            --shadow-float: 0 20px 50px -12px rgba(219, 39, 119, 0.15);
            
            --ai-bubble-bg: #ffffff;
            --user-bubble-bg: var(--accent);
        }

        .dark {
            /* DARK THEME */
            --bg-body: #1a0515;
            --bg-sidebar: rgba(30, 10, 25, 0.7);
            --bg-card: rgba(45, 15, 35, 0.7);
            --bg-glass: rgba(30, 10, 25, 0.8);
            --text-primary: #fdf2f8;
            --text-secondary: #fbcfe8;
            
            --accent: #f472b6;
            --accent-gradient: linear-gradient(135deg, #f472b6 0%, #c026d3 100%);
            --accent-glow: rgba(244, 114, 182, 0.4);
            --accent-light: rgba(244, 114, 182, 0.15);
            
            --border: rgba(255, 255, 255, 0.05);
            --shadow-light: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            
            --ai-bubble-bg: rgba(255, 255, 255, 0.08);
            --user-bubble-bg: var(--accent);
        }

        /* --- GLOBAL & ANIMATIONS --- */
        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            transition: background-color 0.5s ease;
        }

        h1, h2, h3, h4, h5 { font-family: var(--font-header); font-weight: 800; color: var(--text-primary); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(219, 39, 119, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- FLUID BACKGROUND --- */
        .blob-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: -1; overflow: hidden; pointer-events: none; 
        }
        
        .blob { 
            position: absolute; 
            border-radius: 50%; 
            filter: blur(80px); 
            opacity: 0.6; 
            mix-blend-mode: multiply; 
            animation: drift 20s infinite ease-in-out alternate;
        }
        .dark .blob { mix-blend-mode: screen; opacity: 0.3; filter: blur(100px); }

        .blob-1 { width: 500px; height: 500px; background: #fbcfe8; bottom: -100px; left: -100px; animation-duration: 25s; }
        .blob-2 { width: 450px; height: 450px; background: #f5d0fe; top: -50px; right: -50px; animation-duration: 28s; animation-delay: -5s; }
        .blob-3 { width: 350px; height: 350px; background: #f472b6; top: 40%; left: 40%; opacity: 0.4; animation-duration: 35s; animation-delay: -10s; }

        @keyframes drift {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); border-radius: 50%; }
            100% { transform: translate(0, 0) scale(1) rotate(0deg); border-radius: 50%; }
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 50;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }
        
        #sidebar.collapsed {
            width: 0;
            opacity: 0;
            overflow: hidden;
            border-right: none;
        }

        .logo-area {
            padding: 1.8rem 1.5rem 1.5rem;
            font-family: var(--font-header);
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .logo-area sup { font-size: 0.5em; font-weight: 600; top: -0.6em; position: relative; color: var(--text-secondary); opacity: 0.8; }

        .new-chat-btn {
            margin: 0 1rem 1rem;
            padding: 0.8rem 1.2rem;
            background: rgba(255,255,255,0.5);
            border: 2px solid var(--accent);
            border-radius: 1rem;
            color: var(--accent);
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            white-space: nowrap;
        }
        .new-chat-btn:hover { background: var(--accent); color: white; transform: translateY(-2px); box-shadow: 0 6px 15px var(--accent-glow); }

        .history-list { flex: 1; overflow-y: auto; padding: 0 1rem; }

        .chat-item {
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 1rem;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--text-secondary);
            transition: all 0.2s;
            border: 1px solid transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-item:hover { background: var(--accent-light); opacity: 1; color: var(--accent); }
        .chat-item.active { background: var(--bg-card); font-weight: 700; color: var(--text-primary); border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .chat-item .delete-icon { opacity: 0; color: #dc3545; transition: 0.2s; }
        .chat-item:hover .delete-icon { opacity: 1; }

        /* --- WORKSPACE & CHAT --- */
        #workspace { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        /* Resizing Logic */
        #workspace.resizing { user-select: none; cursor: col-resize; }
        #workspace.resizing #chat-pane { pointer-events: none; }
        #workspace.resizing #canvas-pane { pointer-events: none; transition: none; } 

        #chat-pane { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 300px; }

        .top-nav {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .model-pill {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 0.35rem 1rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--accent);
            box-shadow: var(--shadow-light);
            backdrop-filter: blur(10px);
        }

        #chat-stream { flex: 1; overflow-y: auto; padding: 1rem 2rem; scroll-behavior: smooth; }

        /* Messages */
        .message {
            max-width: 800px;
            margin: 0 auto 1.5rem auto;
            display: flex;
            gap: 1rem;
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .avatar {
            width: 2.5rem; height: 2.5rem; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 1rem; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .avatar.ai { background: var(--ai-bubble-bg); color: var(--accent); border: 1px solid var(--border); }
        .avatar.user { background: var(--user-bubble-bg); color: white; }

        .msg-content {
            padding: 1rem 1.25rem;
            border-radius: 1.2rem;
            line-height: 1.6;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            max-width: 100%;
        }
        
        .message.ai .msg-content { background-color: var(--ai-bubble-bg); color: var(--text-primary); border-top-left-radius: 0.2rem; }
        .message.user .msg-content { background-color: var(--user-bubble-bg); color: white; border-top-right-radius: 0.2rem; }
        .dark .message.user .msg-content { color: #fff; }

        .msg-content pre { 
            background: #2d2d2d; border-radius: 0.8rem; padding: 1rem; 
            color: #f8f8f2; overflow-x: auto; margin: 1rem 0; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .msg-content code { font-family: var(--font-code); font-size: 0.9em; }
        
        .msg-content img {
            max-width: 100%;
            border-radius: 0.8rem;
            margin-top: 0.5rem;
        }

        /* Action Buttons */
        .msg-actions {
            display: flex; justify-content: flex-end; gap: 8px;
            margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.05);
        }
        .dark .msg-actions { border-top-color: rgba(255,255,255,0.1); }
        
        .action-btn {
            background: transparent; border: 1px solid transparent; border-radius: 6px;
            color: var(--text-secondary); padding: 4px 8px; font-size: 0.8rem;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px;
        }
        .action-btn:hover { background: var(--accent-light); color: var(--accent); }

        /* Typing Indicator */
        .typing-bubble {
            background: var(--ai-bubble-bg);
            padding: 0.8rem 1.2rem;
            border-radius: 1.2rem;
            border-top-left-radius: 0.2rem;
            display: inline-flex;
            gap: 4px;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .typing-dot {
            width: 6px; height: 6px; background: var(--accent); border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- INPUT AREA --- */
        .input-container {
            max-width: 850px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
            width: 100%;
            position: relative;
        }

        .chat-input-wrapper {
            background: var(--input-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--input-border);
            border-radius: 2rem;
            padding: 0.75rem;
            display: flex;
            align-items: flex-end;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            gap: 0.5rem;
            position: relative;
        }
        .chat-input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: var(--shadow-light-hover);
            transform: translateY(-2px);
        }

        .mode-badge {
            display: none; align-items: center;
            background: var(--accent-light); color: var(--accent);
            padding: 0.4rem 0.8rem; border-radius: 999px;
            font-size: 0.8rem; font-weight: 700;
            white-space: nowrap; margin-bottom: 0.2rem;
            border: 1px solid var(--accent);
        }
        .mode-badge.active { display: flex; }
        .mode-badge .close-mode { margin-left: 0.5rem; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .mode-badge .close-mode:hover { opacity: 1; }

        textarea {
            flex: 1; border: none; background: transparent;
            resize: none; padding: 0.6rem 0.5rem; outline: none;
            color: var(--text-primary); max-height: 150px;
            font-size: 1rem; font-family: var(--bs-body-font-family);
        }
        
        .tool-btn {
            background: transparent; border: none; color: var(--text-secondary);
            padding: 0.6rem; border-radius: 50%; transition: 0.2s;
            cursor: pointer; opacity: 0.7; flex-shrink: 0;
        }
        .tool-btn:hover { background: var(--accent-light); color: var(--accent); opacity: 1; }

        .send-btn {
            background: var(--accent-gradient);
            color: white; border: none; border-radius: 50%;
            width: 2.5rem; height: 2.5rem; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .send-btn:hover { transform: scale(1.1); box-shadow: 0 6px 15px var(--accent-glow); }
        .dark .send-btn { color: white; }

        /* Attachment Preview */
        #attachment-preview {
            position: absolute;
            bottom: 100%;
            left: 20px;
            margin-bottom: 10px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border);
            display: none;
            animation: popIn 0.2s ease-out;
        }
        #attachment-preview.show { display: block; }
        #attachment-preview img {
            height: 60px;
            width: auto;
            border-radius: 8px;
            display: block;
        }
        #attachment-preview .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--text-primary);
            color: var(--bg-body);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- DRAG HANDLE (Resizer) --- */
        #resizer {
            width: 12px;
            margin-left: -6px; margin-right: -6px; /* Overlap for easier clicking */
            cursor: col-resize;
            background: transparent;
            z-index: 60;
            display: none; /* Hidden when canvas closed */
            position: relative;
            flex-shrink: 0;
        }
        #resizer::after {
            content: ''; position: absolute;
            top: 0; bottom: 0; left: 5px;
            width: 2px; background: transparent;
            transition: background 0.2s;
        }
        #resizer:hover::after, #workspace.resizing #resizer::after {
            background: var(--accent);
        }

        /* --- CANVAS PANE --- */
        #canvas-pane {
            width: 0;
            background: var(--bg-body);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            /* Default transition for opening/closing. Removed during drag via JS class */
            transition: width 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            overflow: hidden;
            box-shadow: -5px 0 30px rgba(0,0,0,0.05);
            z-index: 40;
            min-width: 0; /* Important for flex */
        }
        #canvas-pane.open { width: 55%; } /* Default open width */

        .canvas-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); backdrop-filter: blur(10px);
        }

        iframe#preview-frame { flex: 1; border: none; background: white; width: 100%; height: 100%; }

        /* --- UI COMPONENTS --- */
        .preview-btn {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1rem; margin-top: 0.8rem;
            background: var(--accent-light);
            border: none;
            border-radius: 0.8rem; font-size: 0.9rem; font-weight: 700;
            color: var(--accent); cursor: pointer;
            transition: all 0.2s; 
        }
        .preview-btn:hover { 
            background: var(--accent); 
            color: white; transform: translateY(-2px); 
        }
        .dark .preview-btn:hover { color: white; }

        /* Tools Dropdown */
        .custom-dropdown {
            position: absolute; bottom: 110%; left: 1rem;
            background: var(--bg-card); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 1.5rem;
            width: 220px; padding: 0.5rem; z-index: 100;
            display: none; flex-direction: column;
            box-shadow: var(--shadow-light-hover);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .custom-dropdown.show { display: flex; }
        
        .dropdown-item-custom {
            padding: 0.8rem 1.2rem; border-radius: 1rem;
            color: var(--text-primary); text-decoration: none;
            display: flex; align-items: center; gap: 1rem;
            cursor: pointer; font-weight: 700; transition: 0.2s;
        }
        .dropdown-item-custom:hover { background: var(--accent-light); color: var(--accent); }

        /* User Menu */
        .user-menu-area { padding: 1.5rem; border-top: 1px solid var(--border); }
        .user-chip {
            display: flex; align-items: center; gap: 1rem;
            padding: 0.8rem; border-radius: 1.2rem;
            cursor: pointer; transition: 0.2s;
            border: 1px solid transparent; background: rgba(255,255,255,0.5);
        }
        .user-chip:hover { background: var(--bg-card); border-color: var(--border); box-shadow: var(--shadow-light); }

        /* Welcome Screen */
        .hero-title {
            font-family: var(--font-header); font-weight: 800; font-size: 2.5rem;
            color: var(--text-primary); margin-bottom: 1rem;
        }
        
        .suggestion-card {
            background: var(--bg-card); border: 1px solid var(--border);
            padding: 1rem 1.5rem; border-radius: 1.5rem;
            font-weight: 600; color: var(--text-secondary); cursor: pointer;
            transition: all 0.2s; box-shadow: var(--shadow-light);
        }
        .suggestion-card:hover { transform: translateY(-3px); color: var(--accent); box-shadow: var(--shadow-light-hover); }
        
        /* Pricing Cards */
        .pricing-card {
            border: 1px solid var(--border); background: var(--bg-glass);
            border-radius: 1.5rem; padding: 2rem; text-align: center; transition: all 0.3s;
        }
        .pricing-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-light-hover); border-color: var(--accent); }
        .pricing-card.featured { border: 2px solid var(--accent); background: linear-gradient(180deg, var(--bg-card) 0%, var(--accent-light) 100%); }

        .upgrade-btn {
            background: var(--accent-gradient); color: white; border: none; border-radius: 999px;
            padding: 12px 24px; font-weight: 700; width: 100%;
            transition: all 0.3s ease; box-shadow: 0 4px 15px var(--accent-glow);
        }
        .upgrade-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 8px 25px var(--accent-glow); color: white; }

        /* Mobile */
        @media (max-width: 768px) {
            #sidebar { position: fixed; height: 100%; transform: translateX(-100%); width: 280px; }
            #sidebar.open { transform: translateX(0); }
            #canvas-pane.open { position: fixed; width: 100%; height: 100%; z-index: 60; top: 0; right: 0; }
            .hero-title { font-size: 2rem; }
            #resizer { display: none !important; } /* No resizing on mobile */
        }
    </style>
</head>
<body>

    <!-- ANIMATED FLUID BACKGROUND -->
    <div class="blob-container">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar">
        <div class="logo-area">
            ALARA<sup>beta</sup>
            <!-- Mobile Close Button -->
            <button class="btn ms-auto d-md-none text-secondary" id="close-sidebar"><i class="fas fa-times"></i></button>
        </div>
        
        <button id="new-chat-btn" class="new-chat-btn">
            <span>New Chat</span>
            <i class="fas fa-plus"></i>
        </button>
        
        <div id="history-list" class="history-list">
            <!-- Chat history injected here -->
        </div>
        
        <!-- User Profile Area -->
        <div class="user-menu-area">
            <div class="dropdown">
                <div class="user-chip dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="user-menu-btn">
                    <div class="avatar user" style="width: 2.25rem; height: 2.25rem; font-size: 1rem;" id="user-avatar-text">?</div>
                    <div class="overflow-hidden">
                        <div class="fw-bold text-truncate" style="font-size:0.95rem;" id="user-name">Guest</div>
                        <div class="small text-muted text-truncate" style="font-size:0.75rem;" id="user-plan">Free Tier</div>
                    </div>
                </div>
                <ul class="dropdown-menu shadow-lg w-100 border-0 rounded-4 p-2" style="background: var(--bg-card); backdrop-filter: blur(20px);">
                    <li><button class="dropdown-item rounded-3 py-2 fw-bold" onclick="showPricing()"><i class="fas fa-bolt me-3 text-warning"></i> Upgrade</button></li>
                    <li><button class="dropdown-item rounded-3 py-2 fw-bold" onclick="showSettings()"><i class="fas fa-cog me-3 text-secondary"></i> Settings</button></li>
                    <li><hr class="dropdown-divider border-secondary opacity-25"></li>
                    <li><button class="dropdown-item rounded-3 py-2 fw-bold" id="theme-toggle"><i class="fas fa-moon me-3 text-secondary"></i> Toggle Theme</button></li>
                    <li><a class="dropdown-item rounded-3 py-2 text-danger fw-bold" href="/api/auth/logout"><i class="fas fa-sign-out-alt me-3"></i> Logout</a></li>
                </ul>
            </div>
        </div>
    </aside>

    <!-- WORKSPACE -->
    <main id="workspace">
        
        <!-- CHAT PANE -->
        <section id="chat-pane">
            <div class="top-nav">
                <!-- Hamburger / Toggle Sidebar -->
                <button class="btn p-0 text-secondary" id="toggle-sidebar-btn" title="Toggle Sidebar">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                
                <div class="model-pill">
                    <span>Alara Nova</span>
                </div>
                <div style="width: 24px;"></div>
            </div>

            <div id="chat-stream">
                <!-- Welcome State -->
                <div id="welcome-message" class="text-center mt-5 px-3">
                    <div class="mb-4">
                        <div style="width: 100px; height: 100px; background: var(--bg-card); border-radius: 30px; display: inline-flex; align-items: center; justify-content: center; box-shadow: var(--shadow-light); transform: rotate(-5deg);">
                            <i class="fas fa-sparkles fa-3x" style="color: var(--accent);"></i>
                        </div>
                    </div>
                    
                    <h2 class="hero-title">Hello, <span id="welcome-name" style="color: var(--accent);">Friend</span></h2>
                    <p style="color: var(--text-secondary); max-width: 500px; margin: 0 auto; line-height: 1.6;">
                        Your intelligent AI workspace. <br>
                        <span style="font-size: 0.9rem; opacity: 0.8;">Built by a student developer using pre-existing LLMs.</span>
                    </p>
                    
                    <div class="d-flex justify-content-center gap-3 mt-5 flex-wrap">
                        <div class="suggestion-card" onclick="setPrompt('Design a modern landing page for a coffee shop')">üé® Design a Website</div>
                        <div class="suggestion-card" onclick="setPrompt('Explain Quantum Physics like I am 5')">‚öõÔ∏è Explain Physics</div>
                        <div class="suggestion-card" onclick="setPrompt('Write a Python script to organize my files')">üêç Write Code</div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="chat-input-wrapper position-relative">
                    <!-- Tools Button -->
                    <button class="tool-btn" id="tools-btn" title="Add Tool / Attachment">
                        <i class="fas fa-plus fa-lg"></i>
                    </button>
                    
                    <!-- File Upload Button (Paperclip) -->
                    <button class="tool-btn" id="upload-btn" title="Upload Image">
                        <i class="fas fa-paperclip fa-lg"></i>
                    </button>
                    
                    <!-- Mode Badge (Hidden by default) -->
                    <div id="image-mode-badge" class="mode-badge">
                        <i class="fas fa-image me-1"></i> Image Mode
                        <i class="fas fa-times close-mode" onclick="toggleImageMode(false)"></i>
                    </div>

                    <!-- Tools Dropdown -->
                    <div class="custom-dropdown" id="tools-dropdown">
                        <div class="dropdown-item-custom" onclick="toggleImageMode(true)">
                            <i class="fas fa-wand-magic-sparkles" style="color: var(--accent);"></i> Generate Image
                        </div>
                        <div class="dropdown-item-custom" onclick="activateTool('canvas')">
                            <i class="fas fa-code text-warning"></i> Open Canvas
                        </div>
                        <div class="dropdown-item-custom text-muted" style="cursor: not-allowed; opacity: 0.7;">
                            <i class="fas fa-file-powerpoint"></i> Create PPT <span class="badge bg-secondary ms-auto rounded-pill" style="font-size: 0.6em;">SOON</span>
                        </div>
                    </div>

                    <textarea id="chat-input" rows="1" placeholder="Ask Alara anything..."></textarea>
                    
                    <button class="send-btn" id="send-btn">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
                
                <!-- Attachment Preview -->
                <div id="attachment-preview">
                    <img id="preview-img" src="" alt="Attachment">
                    <button class="remove-btn" id="remove-attachment"><i class="fas fa-times"></i></button>
                </div>

                <div class="text-center mt-3">
                    <span class="small fw-bold opacity-50" style="color: var(--text-secondary); letter-spacing: 1px;" id="char-count"></span>
                </div>
            </div>
        </section>

        <!-- RESIZER HANDLE -->
        <div id="resizer"></div>

        <!-- CANVAS PANE -->
        <section id="canvas-pane">
            <div class="canvas-header">
                <div class="fw-bold d-flex align-items-center gap-2" style="color: var(--accent); font-family: var(--font-header);">
                    <i class="fas fa-layer-group"></i> 
                    <span>Canvas Preview</span>
                </div>
                <div class="d-flex gap-2">
                    <button class="soft-button" style="padding: 6px 12px; font-size: 0.8rem; background: var(--accent); color: white;" onclick="downloadCanvas()" title="Download HTML"><i class="fas fa-download me-2"></i>Export</button>
                    <button class="btn btn-sm btn-light text-secondary rounded-circle" style="width: 32px; height: 32px;" onclick="toggleCanvas(false)"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <iframe id="preview-frame" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
        </section>

    </main>

    <!-- SETTINGS MODAL -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-5 shadow-lg" style="background: var(--bg-card); backdrop-filter: blur(20px);">
                <div class="modal-header border-0 pb-0 pt-4 px-4">
                    <h5 class="modal-title fw-bold font-header">Account Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="small text-secondary fw-bold mb-2 ps-1">EMAIL ADDRESS</label>
                        <input type="text" id="settings-email" class="form-control rounded-4 p-3 border-0 bg-light" readonly value="Loading...">
                    </div>
                    
                    <div>
                        <label class="small text-secondary fw-bold mb-2 ps-1">ACTIVE PLAN</label>
                        <div class="p-3 bg-light border-0 rounded-4 d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <div class="bg-white p-2 rounded-3 shadow-sm" style="color: var(--accent);"><i class="fas fa-cube fa-lg"></i></div>
                                <div>
                                    <div class="fw-bold" id="settings-plan-display">Free Plan</div>
                                    <div class="small text-muted">Standard Limits</div>
                                </div>
                            </div>
                            <button class="soft-button" style="padding: 8px 20px; font-size: 0.9rem; border-radius: 99px;" onclick="showPricing()">Upgrade</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PRICING MODAL -->
    <div class="modal fade" id="pricingModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 rounded-5 shadow-lg" style="background: var(--bg-body);">
                <div class="modal-header border-0 pb-0 pt-4 px-4">
                    <h5 class="modal-title fw-bold font-header w-100 text-center fs-3">Upgrade Alara</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-5">
                    <div class="row g-4">
                        <!-- Free Plan -->
                        <div class="col-md-6">
                            <div class="pricing-card h-100">
                                <h3 class="fw-bold mb-2">Free</h3>
                                <p class="text-secondary mb-4">For exploration</p>
                                <ul class="list-unstyled text-start mb-4">
                                    <li class="mb-3"><i class="fas fa-check text-success me-2"></i>Alara Nova Model</li>
                                    <li class="mb-3"><i class="fas fa-check text-success me-2"></i>Standard Chat</li>
                                    <li class="mb-3 text-muted"><i class="fas fa-times me-2"></i>5 Images / Hour</li>
                                </ul>
                                <button class="btn btn-light w-100 rounded-pill py-2 disabled" style="font-weight: 600;">Current Plan</button>
                            </div>
                        </div>
                        <!-- Pro Plan -->
                        <div class="col-md-6">
                            <div class="pricing-card featured h-100 position-relative">
                                <span class="badge bg-warning text-dark position-absolute top-0 end-0 m-3 rounded-pill">RECOMMENDED</span>
                                <h3 class="fw-bold mb-2">Pro</h3>
                                <p class="text-secondary mb-4">For power users</p>
                                <h2 class="fw-bold mb-4" style="color: var(--accent);">‚Çπ199<small class="fs-6 text-muted">/mo</small></h2>
                                <ul class="list-unstyled text-start mb-4">
                                    <li class="mb-3"><i class="fas fa-check text-success me-2"></i><strong>Unlimited</strong> Messages</li>
                                    <li class="mb-3"><i class="fas fa-check text-success me-2"></i>20 Images / Hour</li>
                                    <li class="mb-3"><i class="fas fa-check text-success me-2"></i>Priority Support</li>
                                </ul>
                                <!-- Styled Upgrade Button -->
                                <button class="upgrade-btn">Upgrade Now</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Input for File Upload -->
    <input type="file" id="file-input" class="d-none" accept="image/*">

    <!-- JAVASCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // STATE
            let currentUser = null;
            let currentChatId = null;
            let allChats = [];
            let isCanvasOpen = false;
            let canvasCode = '';
            let typingIndicatorElement = null;
            let currentMode = 'chat'; // 'chat' or 'image'
            let isResizing = false;
            let attachedFile = null;
            let finalSystemPrompt = '';

            // --- SYSTEM PROMPT CONFIGURATION ---
            const baseSystemPrompt = `You are Alara, a knowledgeable, direct, and friendly AI workspace assistant. You were created by a brilliant student developer (not by Google, OpenAI, or any big corp), leveraging powerful pre-existing LLMs as your engine.
            
            YOUR IDENTITY RULES:
            1. ORIGIN: If asked who made you, say you were built by a student developer using pre-existing LLM technology.
            2. NAME: You are Alara, beta v1.0.
            3. TONE: Be helpful, concise, and encourage creativity.`;
            
            const healthRule = `
            CRITICAL HEALTH PROTOCOL:
            If the user mentions physical/mental symptoms, adopt a 'First Aid & Wellness' persona. Identify likely common/non-severe causes (dehydration, stress) and suggest safe home remedies. ALWAYS end with: "**Disclaimer: I am an AI, not a doctor. Please consult a professional.**"`;
            
            const proUpgradeMessage = `
            LIMITATION: If you are generating a very long creative piece (essay, story) for a Free Tier user, you may provide a summary and add: "‚ö†Ô∏è For the full detailed response, please upgrade to Alara Pro." (Note: Do not limit code or technical answers).`;

            // ELEMENTS
            const els = {
                input: document.getElementById('chat-input'),
                sendBtn: document.getElementById('send-btn'),
                stream: document.getElementById('chat-stream'),
                toolsBtn: document.getElementById('tools-btn'),
                uploadBtn: document.getElementById('upload-btn'),
                fileInput: document.getElementById('file-input'),
                attachmentPreview: document.getElementById('attachment-preview'),
                previewImg: document.getElementById('preview-img'),
                removeAttachmentBtn: document.getElementById('remove-attachment'),
                toolsDrop: document.getElementById('tools-dropdown'),
                canvas: document.getElementById('canvas-pane'),
                preview: document.getElementById('preview-frame'),
                history: document.getElementById('history-list'),
                welcome: document.getElementById('welcome-message'),
                sidebar: document.getElementById('sidebar'),
                charCount: document.getElementById('char-count'),
                modeBadge: document.getElementById('image-mode-badge'),
                resizer: document.getElementById('resizer'),
                workspace: document.getElementById('workspace'),
                toggleSidebarBtn: document.getElementById('toggle-sidebar-btn')
            };

            const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
            const pricingModal = new bootstrap.Modal(document.getElementById('pricingModal'));

            window.showSettings = () => settingsModal.show();
            window.showPricing = () => {
                settingsModal.hide();
                pricingModal.show();
            }

            // 1. INITIALIZATION
            init();

            async function init() {
                if(localStorage.getItem('alaraTheme') === 'dark') document.body.classList.add('dark');
                loadHistory();
                await checkAuth();
            }

            async function checkAuth() {
                try {
                    const res = await fetch('/api/user/me');
                    if (res.ok) {
                        const data = await res.json();
                        currentUser = data.user;
                        updateUserUI(data.user);
                    } else {
                        document.getElementById('user-name').innerText = "Guest User";
                        document.getElementById('settings-email').value = "Not Logged In"; 
                        els.input.placeholder = "Log in to chat...";
                        // Default prompt for guest
                        finalSystemPrompt = baseSystemPrompt + healthRule + proUpgradeMessage;
                    }
                } catch (e) { 
                    console.error("Auth check error", e);
                    document.getElementById('settings-email').value = "Guest (Not Logged In)";
                    finalSystemPrompt = baseSystemPrompt + healthRule + proUpgradeMessage;
                }
            }

            function updateUserUI(user) {
                document.getElementById('user-name').innerText = user.name;
                document.getElementById('welcome-name').innerText = user.name.split(' ')[0];
                document.getElementById('user-avatar-text').innerText = user.name.charAt(0).toUpperCase();
                document.getElementById('user-plan').innerText = (user.plan === 'pro' ? 'Pro Plan üåü' : 'Free Tier');
                document.getElementById('settings-email').value = user.email;
                document.getElementById('settings-plan-display').innerText = (user.plan === 'pro' ? 'Pro Plan' : 'Free Plan');
                
                // Construct System Prompt based on Plan
                finalSystemPrompt = baseSystemPrompt + healthRule;
                if (user.plan === 'pro') {
                    els.input.removeAttribute('maxlength');
                    els.charCount.innerText = "Unlimited";
                } else {
                    // Free users get the limiter message
                    finalSystemPrompt += proUpgradeMessage;
                    els.input.setAttribute('maxlength', '5000');
                }
            }

            // 2. CHAT LOGIC
            function createNewChat() {
                const newChat = { id: Date.now().toString(), title: "New Chat", history: [] };
                allChats.unshift(newChat);
                saveChats();
                loadChat(newChat.id);
                // On mobile, close sidebar on new chat
                if(window.innerWidth < 768) {
                    els.sidebar.classList.remove('open'); 
                }
            }

            function loadChat(id) {
                currentChatId = id;
                const chat = allChats.find(c => c.id === id);
                if (!chat) return;

                els.stream.innerHTML = '';
                if (chat.history.length === 0) {
                    els.stream.appendChild(els.welcome);
                    els.welcome.style.display = 'block';
                } else {
                    els.welcome.style.display = 'none';
                    chat.history.forEach(msg => {
                        const text = msg.parts[0].text;
                        const role = msg.role === 'model' ? 'ai' : 'user';
                        
                        // Check for inline images in history (if any) or text URLs
                        if(role === 'ai' && text.startsWith('http') && text.includes('pollinations')) {
                            appendImage(text, 'ai');
                        } else {
                            // If user message has image data, we handle it slightly differently in real app
                            // For now, we assume simple text history or text + image display
                            appendMessage(text, role);
                        }
                    });
                }
                renderHistoryList();
            }

            // Sidebar Toggle Logic
            els.toggleSidebarBtn.addEventListener('click', () => {
                if(window.innerWidth < 768) {
                    els.sidebar.classList.toggle('open'); // Mobile behavior
                } else {
                    els.sidebar.classList.toggle('collapsed'); // Desktop behavior
                }
            });
            // Mobile close button inside sidebar
            document.getElementById('close-sidebar').addEventListener('click', () => els.sidebar.classList.remove('open'));


            // Mode Switching Logic
            window.toggleImageMode = function(active) {
                currentMode = active ? 'image' : 'chat';
                els.toolsDrop.classList.remove('show');
                
                if (active) {
                    els.modeBadge.classList.add('active');
                    els.input.placeholder = "Describe the image you want to generate...";
                    els.input.focus();
                } else {
                    els.modeBadge.classList.remove('active');
                    els.input.placeholder = "Ask Alara anything...";
                }
            }

            // File Upload Logic
            els.uploadBtn.addEventListener('click', () => els.fileInput.click());
            
            els.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onloadend = () => {
                    attachedFile = {
                        base64: reader.result.split(',')[1],
                        mimeType: file.type,
                        url: reader.result
                    };
                    els.previewImg.src = reader.result;
                    els.attachmentPreview.classList.add('show');
                };
                reader.readAsDataURL(file);
            });

            els.removeAttachmentBtn.addEventListener('click', () => {
                attachedFile = null;
                els.fileInput.value = '';
                els.attachmentPreview.classList.remove('show');
            });

            async function handleSend() {
                if (currentMode === 'image') {
                    const prompt = els.input.value.trim();
                    if(prompt) {
                        generateImage(prompt);
                        toggleImageMode(false); 
                        els.input.value = '';
                        els.input.style.height = 'auto';
                    }
                } else {
                    sendMessage();
                }
            }

            async function sendMessage() {
                if (!currentUser) {
                    window.location.href = '/api/auth/login';
                    return;
                }

                const text = els.input.value.trim();
                if (!text && !attachedFile) return;

                els.input.value = '';
                els.input.style.height = 'auto'; 
                els.welcome.style.display = 'none';

                // Display User Message
                if(attachedFile) {
                    appendImage(attachedFile.url, 'user');
                }
                if(text) {
                    appendMessage(text, 'user');
                }
                
                const currentChat = allChats.find(c => c.id === currentChatId);
                if (!currentChat) return; 
                
                // Construct Payload
                const newParts = [];
                if (text) newParts.push({ text: text });
                if (attachedFile) {
                    newParts.push({ 
                        inlineData: { 
                            mimeType: attachedFile.mimeType, 
                            data: attachedFile.base64 
                        } 
                    });
                }

                // Add to History
                currentChat.history.push({ role: 'user', parts: newParts });
                
                if (currentChat.title === "New Chat" && text) {
                    currentChat.title = text.substring(0, 20) + "...";
                    renderHistoryList();
                }

                // Clear Attachment UI
                const wasAttached = attachedFile;
                attachedFile = null;
                els.attachmentPreview.classList.remove('show');
                els.fileInput.value = '';

                showTyping();

                try {
                    // Inject System Instructions into the API call
                    const requestBody = { 
                        contents: currentChat.history,
                        systemInstruction: {
                            parts: [{ text: finalSystemPrompt }]
                        }
                    };

                    const res = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    hideTyping();

                    const data = await res.json();
                    
                    if (data.error) {
                        appendMessage(`‚ö†Ô∏è Error: ${data.details || data.error}`, 'ai');
                    } else if (data.candidates) {
                        const reply = data.candidates[0].content.parts[0].text;
                        appendMessage(reply, 'ai');
                        currentChat.history.push({ role: 'model', parts: [{ text: reply }] });
                        saveChats();
                    }
                } catch (e) {
                    hideTyping();
                    appendMessage("‚ö†Ô∏è Connection error. Please check network.", 'ai');
                }
            }

            function showTyping() {
                if(typingIndicatorElement) return;
                
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                msgDiv.id = 'typing-indicator';
                
                const avatar = document.createElement('div');
                avatar.className = `avatar ai`;
                avatar.innerText = 'AI';
                
                const bubble = document.createElement('div');
                bubble.className = 'typing-bubble';
                bubble.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                
                msgDiv.append(avatar, bubble);
                els.stream.appendChild(msgDiv);
                els.stream.scrollTop = els.stream.scrollHeight;
                typingIndicatorElement = msgDiv;
            }

            function hideTyping() {
                if(typingIndicatorElement) {
                    typingIndicatorElement.remove();
                    typingIndicatorElement = null;
                }
            }

            function appendMessage(text, sender) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${sender}`;
                
                const avatar = document.createElement('div');
                avatar.className = `avatar ${sender}`;
                avatar.innerText = sender === 'ai' ? 'AI' : 'U';
                
                const content = document.createElement('div');
                content.className = 'msg-content';
                
                content.innerHTML = marked.parse(text);

                if (window.renderMathInElement) {
                    renderMathInElement(content, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }

                content.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                    // Check for HTML/CSS to enable Canvas
                    if (block.classList.contains('language-html') || block.classList.contains('language-xml')) {
                        // If Canvas is ALREADY open, auto-update
                        if(isCanvasOpen) {
                            loadCanvas(block.innerText);
                        }
                        
                        const btn = document.createElement('button');
                        btn.className = 'preview-btn';
                        btn.innerHTML = '<i class="fas fa-play me-2"></i> Open in Canvas';
                        btn.onclick = () => loadCanvas(block.innerText);
                        block.parentElement.after(btn);
                    }
                });

                if(sender === 'ai') {
                    msgDiv.append(avatar, content);
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'msg-actions';
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'action-btn';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(text);
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied';
                        setTimeout(() => copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy', 2000);
                    };

                    const pdfBtn = document.createElement('button');
                    pdfBtn.className = 'action-btn';
                    pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> PDF';
                    pdfBtn.onclick = () => downloadMessageAsPDF(content);

                    actionsDiv.append(copyBtn, pdfBtn);
                    content.appendChild(actionsDiv);

                } else {
                    msgDiv.style.flexDirection = 'row-reverse';
                    msgDiv.append(avatar, content);
                }
                
                els.stream.appendChild(msgDiv);
                els.stream.scrollTop = els.stream.scrollHeight;
            }

            function downloadMessageAsPDF(element) {
                const clone = element.cloneNode(true);
                const actions = clone.querySelector('.msg-actions');
                if(actions) actions.remove();
                
                const wrapper = document.createElement('div');
                wrapper.style.padding = '20px';
                wrapper.style.background = 'white';
                wrapper.style.color = 'black';
                wrapper.appendChild(clone);
                document.body.appendChild(wrapper);

                html2canvas(wrapper, { scale: 2, useCORS: true }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF();
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save('alara-chat.pdf');
                    document.body.removeChild(wrapper);
                });
            }

            function appendImage(url, sender) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${sender}`;
                const avatar = document.createElement('div');
                avatar.className = `avatar ${sender}`;
                avatar.innerText = sender === 'ai' ? 'AI' : 'U';
                const content = document.createElement('div');
                content.className = 'msg-content';
                content.innerHTML = `<img src="${url}" class="img-fluid rounded-4 shadow-sm" style="max-height: 400px;">`;
                
                if(sender === 'ai') {
                    msgDiv.append(avatar, content);
                } else {
                    msgDiv.style.flexDirection = 'row-reverse';
                    msgDiv.append(avatar, content);
                }
                
                els.stream.appendChild(msgDiv);
                els.stream.scrollTop = els.stream.scrollHeight;
            }

            // 3. CANVAS LOGIC
            window.toggleCanvas = function(forceState) {
                isCanvasOpen = forceState !== undefined ? forceState : !isCanvasOpen;
                if (isCanvasOpen) {
                    els.canvas.classList.add('open');
                    els.resizer.style.display = 'block';
                } else {
                    els.canvas.classList.remove('open');
                    els.resizer.style.display = 'none';
                    els.canvas.style.width = ''; // Reset width on close
                }
            };

            window.loadCanvas = function(code) {
                canvasCode = code;
                toggleCanvas(true);
                els.preview.srcdoc = code;
            };

            window.downloadCanvas = function() {
                if(!canvasCode) return;
                const blob = new Blob([canvasCode], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'alara-canvas.html';
                a.click();
            };

            // 4. RESIZER LOGIC
            els.resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                els.workspace.classList.add('resizing');
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
            });

            function handleResize(e) {
                if (!isResizing) return;
                const newWidth = window.innerWidth - e.clientX;
                if (newWidth > 300 && newWidth < window.innerWidth - 300) {
                    els.canvas.style.width = `${newWidth}px`;
                }
            }

            function stopResize() {
                isResizing = false;
                els.workspace.classList.remove('resizing');
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }

            // 5. TOOLS LOGIC
            window.activateTool = function(tool) {
                els.toolsDrop.classList.remove('show');
                if (tool === 'image') {
                    toggleImageMode(true);
                } else if (tool === 'canvas') {
                    toggleCanvas(true);
                    els.preview.srcdoc = `
                        <div style="font-family:sans-serif; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#64748b;">
                            <h2>Canvas Ready</h2>
                            <p>Ask Alara to write HTML code, then click "Open in Canvas".</p>
                        </div>
                    `;
                }
            };

            async function generateImage(prompt) {
                if(!currentUser) return alert("Please log in.");
                appendMessage(`üé® Generating image: *"${prompt}"*...`, 'ai');
                showTyping();
                
                try {
                    const res = await fetch('/api/imagine', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prompt })
                    });
                    hideTyping();
                    const data = await res.json();
                    
                    if(data.imageUrl) {
                        appendImage(data.imageUrl, 'ai');
                        const chat = allChats.find(c => c.id === currentChatId);
                        chat.history.push({ role: 'model', parts: [{ text: data.imageUrl }] });
                        saveChats();
                    }
                } catch(e) {
                    hideTyping();
                    appendMessage("Failed to generate image.", 'ai');
                }
            }

            // 6. HISTORY & UTILS
            function saveChats() {
                localStorage.setItem('alaraAllChats', JSON.stringify(allChats));
            }

            function loadHistory() {
                const saved = localStorage.getItem('alaraAllChats');
                if (saved) {
                    allChats = JSON.parse(saved);
                    if (allChats.length === 0) createNewChat();
                    else loadChat(allChats[0].id);
                } else {
                    createNewChat();
                }
            }

            function renderHistoryList() {
                els.history.innerHTML = '';
                allChats.forEach(chat => {
                    const div = document.createElement('div');
                    div.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                    div.innerHTML = `
                        <span>${chat.title}</span>
                        <i class="fas fa-trash delete-icon" onclick="deleteChat('${chat.id}', event)"></i>
                    `;
                    div.onclick = (e) => {
                        if (!e.target.classList.contains('delete-icon')) loadChat(chat.id);
                    };
                    els.history.appendChild(div);
                });
            }

            window.deleteChat = function(id, e) {
                e.stopPropagation();
                if(confirm("Delete this chat?")) {
                    allChats = allChats.filter(c => c.id !== id);
                    saveChats();
                    if(allChats.length > 0) loadChat(allChats[0].id);
                    else createNewChat();
                }
            }

            window.setPrompt = function(text) {
                els.input.value = text;
                els.input.focus();
            }

            // EVENT LISTENERS
            els.sendBtn.addEventListener('click', handleSend);
            els.input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
            });
            els.input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if(this.value.length > 0 && currentUser?.plan !== 'pro') {
                    els.charCount.innerText = `${this.value.length}/5000`;
                } else {
                    els.charCount.innerText = "";
                }
            });

            els.toolsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                els.toolsDrop.classList.toggle('show');
            });

            document.getElementById('new-chat-btn').addEventListener('click', createNewChat);
            
            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.body.classList.toggle('dark');
                localStorage.setItem('alaraTheme', document.body.classList.contains('dark') ? 'dark' : 'light');
            });

            // document.getElementById('open-sidebar').addEventListener('click', () => els.sidebar.classList.add('open'));
            // Note: open-sidebar button removed in favor of unified toggle logic

            window.addEventListener('click', () => els.toolsDrop.classList.remove('show'));

        });
    </script>
</body>
</html>
