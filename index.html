<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alara - Your Friendly AI Companion</title>
    
    <!-- BOOTSTRAP CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
      window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>

    <style>
        :root {
            --bs-body-font-family: 'Nunito', sans-serif;
            --bg-color: hsl(210, 20%, 98%);
            --text-color: hsl(210, 10%, 25%);
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: rgba(210, 180, 200, 0.4);
            --primary-accent: hsl(320, 80%, 65%);
            --secondary-accent: hsl(320, 90%, 85%);
            --ai-bubble-bg: hsl(320, 100%, 97%);
            --user-bubble-bg: hsl(320, 80%, 65%);
            --system-bubble-bg: hsl(210, 20%, 92%);
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-border: hsl(320, 50%, 85%);
            --sidebar-bg: rgba(255, 255, 255, 0.95);
            --shadow-light: 0 8px 32px 0 rgba(0, 0, 0, 0.08);
            --shadow-light-hover: 0 12px 40px 0 rgba(0, 0, 0, 0.1);
        }
        .dark {
            --bg-color: hsl(220, 25%, 15%);
            --text-color: hsl(210, 20%, 85%);
            --card-bg: rgba(15, 25, 40, 0.85);
            --card-border: rgba(0, 200, 220, 0.3);
            --primary-accent: hsl(190, 90%, 60%);
            --secondary-accent: hsl(190, 70%, 75%);
            --ai-bubble-bg: hsl(220, 20%, 25%);
            --user-bubble-bg: hsl(190, 90%, 60%);
            --system-bubble-bg: hsl(220, 20%, 35%);
            --input-bg: rgba(15, 25, 40, 0.9);
            --input-border: hsl(190, 70%, 75%);
            --sidebar-bg: rgba(15, 25, 40, 0.98);
            --shadow-light: 0 8px 32px 0 rgba(0, 246, 255, 0.05);
            --shadow-light-hover: 0 12px 40px 0 rgba(0, 246, 255, 0.08);
        }
        body { background-color: var(--bg-color); color: var(--text-color); overflow-x: hidden; position: relative; transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out; }
        .blob-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .blob { position: absolute; border-radius: 50%; opacity: 0.4; filter: blur(50px); animation: move 25s infinite alternate; }
        .blob-1 { width: 350px; height: 350px; background-color: var(--secondary-accent); top: -80px; left: -80px; animation-duration: 22s; }
        .blob-2 { width: 450px; height: 450px; background-color: var(--primary-accent); bottom: -120px; right: -120px; animation-duration: 32s; }
        .blob-3 { width: 300px; height: 300px; background-color: var(--secondary-accent); top: 50%; left: 50%; transform: translate(-50%, -50%); animation-duration: 27s; }
        .dark .blob { opacity: 0.15; filter: blur(60px); }
        @keyframes move { from { transform: rotate(0deg) scale(1.1) translateX(-30px); } to { transform: rotate(360deg) scale(1) translateX(30px); } }
        h1, h2, h3 { font-family: 'Poppins', sans-serif; font-weight: 800; color: var(--text-color); }
        .dark h1, .dark h2, .dark h3 { color: #fff; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--secondary-accent); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-accent); }
        .soft-card { background: var(--card-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--card-border); border-radius: 20px; box-shadow: var(--shadow-light); transition: all 0.3s ease-in-out; }
        .soft-card:hover { transform: translateY(-5px) scale(1.01); box-shadow: var(--shadow-light-hover); }
        .soft-button { background-color: var(--primary-accent); color: white; border-radius: 9999px; padding: 12px 28px; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: all 0.3s ease-in-out; border: none; }
        .soft-button:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
        .dark .soft-button { color: hsl(220, 25%, 15%); box-shadow: 0 4px 15px rgba(0, 246, 255, 0.15); }
        .dark .soft-button:hover { box-shadow: 0 6px 20px rgba(0, 246, 255, 0.25); }
        .nav-link { color: var(--text-color); transition: color 0.3s; font-size: 1.125rem; }
        .nav-link.active { color: var(--primary-accent); font-weight: 700; }
        .nav-link:hover { color: var(--primary-accent); }
        .typing-cursor { display: inline-block; width: 2px; height: 1em; background-color: var(--primary-accent); animation: blink 0.7s infinite; margin-left: 4px; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }
        .page-section { display: none; animation: fadeIn 0.8s ease-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chat-message { animation: popIn 0.3s ease-out; position: relative; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .ai-typing-indicator span { animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        pre[class*="language-"] { max-height: 400px; overflow-y: auto; background: #2d2d2d; border-radius: 0.75rem; border: none; font-size: 0.9em; padding: 1.25rem; position: relative; }
        code[class*="language-"] { font-size: 0.9em; font-family: 'Fira Code', 'Monaco', monospace; word-break: normal; white-space: pre; }
        .copy-code-button { position: absolute; top: 0.75rem; right: 0.75rem; background-color: rgba(255, 255, 255, 0.2); color: white; padding: 0.4rem 0.6rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.8em; font-weight: 600; opacity: 0; transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out; border: none; display: flex; align-items: center; justify-content: center; gap: 0.25rem; }
        pre:hover .copy-code-button { opacity: 1; }
        .copy-code-button:hover { background-color: rgba(255, 255, 255, 0.3); }
        .copy-code-button.copied { background-color: var(--primary-accent); color: white; opacity: 1; }
        .dark .copy-code-button { background-color: rgba(0, 0, 0, 0.3); }
        .dark .copy-code-button:hover { background-color: rgba(0, 0, 0, 0.4); }
        :not(pre) > code[class*="language-"] { background: var(--system-bubble-bg); color: var(--text-color); padding: .2em .4em; border-radius: .4em; }
        .dark :not(pre) > code[class*="language-"] { background: #3e3e3e; color: #f0f0f0; }
        
        /* Fixed PDF button visibility */
        .pdf-button { 
            opacity: 0; 
            transition: opacity 0.3s ease; 
        }
        .chat-message:hover .pdf-button { 
            opacity: 1; 
        }
        
        /* Better button container positioning */
        .message-actions { 
            position: absolute; 
            top: -12px; 
            right: -12px; 
            z-index: 10; 
            display: flex; 
            gap: 4px; 
            opacity: 0; 
            transition: opacity 0.3s ease; 
        }
        .chat-message:hover .message-actions { 
            opacity: 1; 
        }
        
        .ai-bubble { background-color: var(--ai-bubble-bg); color: var(--text-color); border-bottom-left-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .user-bubble { background-color: var(--user-bubble-bg); color: white; border-bottom-right-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .dark .user-bubble { color: hsl(220, 25%, 15%); }
        .system-bubble { background-color: var(--system-bubble-bg); color: var(--text-color); box-shadow: 0 1px 4px rgba(0,0,0,0.03); }
        .message-content { word-break: break-word; overflow-wrap: break-word; font-size: 0.975rem; line-height: 1.6; }
        .message-content img { max-height: 60vh; margin-top: 0.5rem; border-radius: 0.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #chat-input { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text-color); transition: border-color 0.3s ease; }
        #chat-input:focus { border-color: var(--primary-accent); box-shadow: none; }
        #chat-input:disabled { cursor: not-allowed; background-color: var(--system-bubble-bg); }
        #chat-sidebar { position: fixed; top: 0; left: -320px; width: 320px; height: 100%; background-color: var(--sidebar-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); transition: left 0.3s ease-in-out; z-index: 1050; padding: 1.5rem; display: flex; flex-direction: column; border-right: 1px solid var(--card-border); }
        #chat-sidebar.open { left: 0; }
        #home::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--secondary-accent) 0%, rgba(255,255,255,0) 50%, var(--primary-accent) 100%); opacity: 0.1; z-index: -1; transition: background 0.4s ease-in-out, opacity 0.4s ease-in-out; }
        .dark #home::before { background: linear-gradient(135deg, var(--secondary-accent) 0%, rgba(0,0,0,0) 50%, var(--primary-accent) 100%); opacity: 0.08; }
        
        /* Enhanced PDF rendering for mathematical symbols */
        .pdf-render-scale { 
            font-size: 1.3em !important; 
            line-height: 1.6 !important; 
        }
        .pdf-render-scale .katex { 
            font-size: 1.2em !important; 
        }
        .pdf-render-scale .katex-display { 
            margin: 1em 0 !important; 
        }
        
        .navbar-brand sup { font-size: 0.5em; font-weight: normal; }
        .navbar .soft-button { padding: .5rem 1.5rem !important; font-size: .875rem !important; }
        .auth-loading { display: inline-block; width: 1rem; height: 1rem; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Loading spinner for image generation */
        .image-generating {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .image-generating::after {
            content: "";
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary-accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="position-relative d-flex flex-column vh-100">
    <div class="blob-container">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <aside id="chat-sidebar" class="soft-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fs-4 fw-bold">Chat History</h2>
            <button id="close-sidebar-button" class="btn-close" aria-label="Close"></button>
        </div>
        <button id="new-chat-button" class="btn btn-outline-primary rounded-pill w-100 mb-3 p-2 fw-semibold" style="--bs-btn-color: var(--primary-accent); --bs-btn-border-color: var(--primary-accent); --bs-btn-hover-bg: var(--primary-accent); --bs-btn-hover-border-color: var(--primary-accent);">+ New Chat</button>
        <div id="chat-history-list" class="flex-grow-1 overflow-y-auto"></div>
    </aside>

    <header class="position-fixed top-0 start-0 end-0 z-3">
        <div class="container-xl px-3 py-3">
            <nav class="navbar navbar-expand-md soft-card px-4 py-2 rounded-pill shadow-lg">
                <a href="#home" class="navbar-brand fs-2 fw-bolder nav-link" style="color: var(--primary-accent);">ALARA<sup>beta</sup></a>
                <button id="mobile-menu-button" class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <svg style="width: 2rem; height: 2rem; color: var(--primary-accent);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item"><a href="#home" class="nav-link px-3 active">Home</a></li>
                        <li class="nav-item"><a href="#chat" class="nav-link px-3">Chat</a></li>
                        <li class="nav-item"><a href="#pricing" class="nav-link px-3">Pricing</a></li>
                        <li class="nav-item"><a href="#about" class="nav-link px-3">About</a></li>
                        <li class="nav-item ps-md-3" id="user-auth-section">
                            <div class="auth-loading"></div>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <main class="pt-5 flex-grow-1" style="padding-top: 7rem !important;">
        <section id="home" class="page-section active position-relative vh-100">
            <div class="container-xl px-3 text-center h-100 d-flex flex-column justify-content-center align-items-center">
                <h1 id="hero-title" class="display-1 fw-bolder mb-4" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);"></h1>
                <p class="fs-4 lead mx-auto mb-5" style="max-width: 48rem; opacity: 0.85;">Your intelligent AI companion for creativity, conversation, and code.</p>
                <a href="#chat" class="soft-button fs-5">Start Chatting</a>
            </div>
        </section>

        <section id="chat" class="page-section vh-100 d-flex flex-column">
             <button id="sidebar-toggle" class="d-none d-md-block position-fixed start-0 ms-3 soft-card p-3 rounded-pill z-3" style="color: var(--primary-accent); top: 8rem;">
                 <svg style="height: 1.5rem; width: 1.5rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <div class="container-xl px-4 py-5 h-100 d-flex flex-column">
                <div id="login-cta" class="d-none h-100 flex-column justify-content-center align-items-center text-center p-5">
                    <h2 class="fs-2 fw-bold mb-4">Welcome to Alara</h2>
                    <p class="fs-5 mb-5 mx-auto" style="max-width: 32rem; opacity: 0.8;">Please log in with your Google account to begin your conversation.</p>
                    <a href="/api/auth/login" class="soft-button fs-5 d-flex align-items-center" style="gap: 0.75rem;">
                        <svg class="w-6 h-6" style="width:1.5rem; height:1.5rem" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,36.566,44,30.85,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                        Login with Google
                    </a>
                </div>
                
                <div id="chat-box" class="flex-grow-1 overflow-y-auto p-3 d-flex flex-column gap-3"></div>
                <input type="file" id="image-input" class="d-none" accept="image/*">
                
                <div class="input-area-container mt-3 soft-card p-3 rounded-4"> 
                    <div id="image-preview-container" class="mb-2"></div>
                    <div class="position-relative d-flex align-items-end gap-2">
                        <textarea id="chat-input" placeholder="Type your message or image prompt..." rows="1" maxlength="5000" class="form-control rounded-pill py-2 px-4" style="resize: none;"></textarea>
                        <div class="position-absolute d-flex align-items-center gap-1" style="right: 0.75rem; bottom: 0.5rem;">
                            <button id="upload-image-button" class="btn rounded-pill p-2" title="Upload Image">
                                <svg style="height: 1.5rem; width: 1.5rem; color: var(--primary-accent);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            </button>
                            <button id="generate-image-button" class="btn rounded-pill p-2" title="Generate Image from Text">
                                <svg style="height: 1.5rem; width: 1.5rem; color: var(--primary-accent);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.008 2.008a1 1 0 010 1.414L10 17.414l-2 2V19h-.5l-2-2-.5-.5H4.5l-2-2-.5-.5v-.5l-.5-2 2-2 2-2 2-2 2-2 2-2zM15 5h.01M19 8h.01M15 11h.01" />
                                </svg>
                            </button>
                            <button id="send-button" class="soft-button d-flex align-items-center justify-content-center" style="width: 2.5rem; height: 2.5rem; padding: 0.5rem;">
                                <!-- Icon will be set by JavaScript -->
                            </button>
                        </div>
                    </div>
                    <div id="char-counter" class="form-text text-end mt-1 pe-2">0 / 5000</div>
                </div>
            </div>
        </section>

        <section id="pricing" class="page-section">
             <div class="container-xl px-4 py-5">
                <div class="text-center mb-5">
                    <h2 class="display-4 fw-bolder mb-3">Choose Your Plan</h2>
                    <p class="fs-5 lead mx-auto" style="max-width: 40rem;">Get started for free or unlock Alara's full potential with our Pro plan.</p>
                </div>
                <div class="row g-4 justify-content-center">
                    <div class="col-md-6 col-lg-5">
                        <div id="free-plan-card" class="soft-card p-4 h-100 d-flex flex-column">
                            <h3 class="fs-2 fw-bold mb-2">Free</h3>
                            <p class="fs-5 mb-4 text-secondary">For casual users & exploration</p>
                            <ul class="list-unstyled flex-grow-1 mb-4">
                                <li class="d-flex align-items-center mb-3"><span class="text-success me-2">✓</span>Alara Nova Model</li>
                                <li class="d-flex align-items-center mb-3"><span class="text-success me-2">✓</span>Standard Chat Responses</li>
                                <li class="d-flex align-items-center mb-3"><span class="text-success me-2">✓</span>Local Chat History</li>
                                <li class="d-flex align-items-center mb-3"><span class="text-danger me-2">✗</span>5 Image Generations / Hour</li>
                                <li class="d-flex align-items-center"><span class="text-danger me-2">✗</span>Limited Prompt Length</li>
                            </ul>
                            <button id="free-plan-button" class="soft-button btn-secondary disabled">Your Current Plan</button>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-5">
                        <div id="pro-plan-card" class="soft-card p-4 h-100 d-flex flex-column">
                            <h3 class="fs-2 fw-bold mb-2">Alara Pro</h3>
                            <p class="fs-5 mb-4 text-secondary">For power users & professionals</p>
                            <ul class="list-unstyled flex-grow-1 mb-4">
                                <li class="d-flex align-items-center mb-3"><span class="text-success me-2">✓</span>Alara Nova Pro Model</li>
                                <li class="d-flex align-items-center mb-3"><span class="text-success me-2">✓</span><strong class="fw-semibold">Full & In-depth Responses</strong></li>
                                <li class="d-flex align-items-center mb-3"><span class="text-success me-2">✓</span><strong class="fw-semibold">15-20</strong> Image Generations / Hour</li>
                                <li class="d-flex align-items-center mb-3"><span class="text-success me-2">✓</span><strong class="fw-semibold">No Prompt Length Limits</strong></li>
                                <li class="d-flex align-items-center mb-3"><span class="text-success me-2">✓</span><strong class="fw-semibold">Higher API Rate Limits</strong></li>
                                <li class="d-flex align-items-center"><span class="text-secondary me-2">✓</span>Cloud Synced History <span class="badge bg-secondary ms-2">Coming Soon</span></li>
                            </ul>
                            <button id="pro-plan-button" class="soft-button">Upgrade to Pro - ₹199/mo</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="about" class="page-section">
            <div class="container-xl px-4 py-5 text-center">
                <h2 class="display-4 fw-bolder mb-4">About Alara</h2>
                <div class="fs-5 mx-auto" style="max-width: 48rem; opacity: 0.85;">
                    <p class="mb-3">Alara is an intelligent AI companion designed for creativity, conversation, and code. Our mission is to create an AI that feels less like a tool and more like a partner, adjusting its personality to be the perfect assistant for any task.</p>
                    <p>Created by a brilliant developer, Alara leverages powerful existing LLMs to help bring new possibilities to life quickly. The vision, design, and implementation are entirely their work, focusing on a proprietary architecture that blends foundational AI technologies with unique creative development.</p>
                </div>
            </div>
        </section>
    </main>

    <button id="theme-toggle" class="fixed-bottom-right m-3 soft-card p-3 rounded-pill">
        <svg id="theme-icon-light" style="height: 1.5rem; width: 1.5rem; color: var(--primary-accent);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        <svg id="theme-icon-dark" class="d-none" style="height: 1.5rem; width: 1.5rem; color: var(--primary-accent);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
    </button>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.page-section');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('navbarNav');
            const heroTitle = document.getElementById('hero-title');
            const chatBox = document.getElementById('chat-box');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const uploadImageButton = document.getElementById('upload-image-button');
            const imageInput = document.getElementById('image-input');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const sidebar = document.getElementById('chat-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle'); 
            const closeSidebarButton = document.getElementById('close-sidebar-button');
            const newChatButton = document.getElementById('new-chat-button');
            const chatHistoryList = document.getElementById('chat-history-list');
            const charCounter = document.getElementById('char-counter');
            const generateImageButton = document.getElementById('generate-image-button');
            const userAuthSection = document.getElementById('user-auth-section');
            const loginCta = document.getElementById('login-cta');
            
            let allChats = [];
            let currentChatId = null;
            let abortController = new AbortController();
            let attachedFile = null;
            let typingAnimationTimeout = null;
            let currentHeroCharIndex = 0;
            const heroText = "Your Friendly AI Companion";
            let currentUser = null; 
            let systemPrompt = '';
            let imageGenerationLimit = 5;
            let isAwaitingResponse = false;
            let authCheckInProgress = false;
            let imageGenerationCount = 0;
            let imageGenerationResetTime = Date.now();
            
            // STRICTER SYSTEM PROMPT
            const baseSystemPrompt = `You are Alara, a knowledgeable and direct AI workspace assistant. You were created by a brilliant student developer (NOT by Google, OpenAI, or any big tech company), leveraging powerful pre-existing LLMs as your engine.
            
            CRITICAL IDENTITY RULES:
            1. ORIGIN: If asked who made you, say: "I was built by a student developer using pre-existing Large Language Models." NEVER claim to be trained by Google or Gemini.
            2. NAME: You are Alara, beta v1.0.
            3. TONE: Be helpful, concise, and encourage creativity.
            4. CODE: Provide complete, runnable code (HTML/CSS/JS in one block) followed by a brief explanation.
            `;
            const proUpgradeMessage = ` CRITICAL RULE FOR LONG RESPONSES: If the user requests a long-form text output like an essay, a story, a business plan, or a detailed article, you must provide a concise, high-quality summary or the first complete paragraph (approximately 150 words). After this summary, on a new line, you must include the following message with a warning symbol: '⚠️ For the full, detailed response, please upgrade to Alara Pro.' This rule does NOT apply to requests for code, tables, or step-by-step instructions.`;
            const healthRule = ` CRITICAL RULE FOR HEALTH-RELATED QUERIES: If a user describes physical or mental health symptoms (e.g., 'I have a headache,' 'I'm feeling anxious,' 'my stomach hurts'), you MUST adopt a helpful but extremely cautious 'First Aid & General Wellness' persona. You are not a doctor. You MUST follow these steps: 1. Acknowledge their symptoms empathetically. 2. Identify the MOST LIKELY and COMMON, NON-SEVERE condition that could cause these symptoms (e.g., headache -> dehydration, stress; stomach ache -> indigestion). 3. Suggest ONLY universally safe, common-sense home remedies (e.g., 'drink a glass of water,' 'get some rest,' 'try some ginger tea,' 'take an ORS'). 4. Under no circumstances should you name specific diseases or recommend any prescription or branded medication. 5. You MUST conclude your response with a clear, bolded disclaimer: '**Disclaimer: I am an AI assistant and not a medical professional. This is general guidance and not a substitute for professional medical advice. Please consult a doctor for an accurate diagnosis.**' For the user example 'I'm feeling nauseic, headaches and bile juice vomits', a perfect response would be: 'It sounds like you're feeling really unwell. Those symptoms can often be a sign of dehydration. A good first step would be to rehydrate slowly by sipping on water or an Oral Rehydration Solution (ORS). **Disclaimer: I am an AI assistant and not a medical professional. This is general guidance and not a substitute for professional medical advice. If your symptoms persist or worsen, please consult a doctor for an accurate diagnosis.**'`;
            
            // Check for authentication status on page load and after OAuth redirect
            async function checkAuthStatus() {
                if (authCheckInProgress) return;
                authCheckInProgress = true;

                try {
                    // Add a small delay to allow for backend session processing
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const response = await fetch('/api/user/me', {
                        method: 'GET',
                        credentials: 'include', // Important for cookies/sessions
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (response.ok) {
                        const { user } = await response.json();
                        currentUser = user;
                        updateAuthUI(true);
                    } else if (response.status === 401) {
                        currentUser = null;
                        updateAuthUI(false);
                    } else {
                        // Server error - retry after delay
                        setTimeout(() => {
                            authCheckInProgress = false;
                            checkAuthStatus();
                        }, 2000);
                        return;
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    // Retry after delay on network error
                    setTimeout(() => {
                        authCheckInProgress = false;
                        checkAuthStatus();
                    }, 2000);
                    return;
                } finally {
                    authCheckInProgress = false;
                }

                initializeFeatures();
                updatePricingUI();
            }

            function updateAuthUI(isLoggedIn) {
                if (isLoggedIn && currentUser) {
                    const firstName = currentUser.name.split(' ')[0];
                    const loggedInHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <span class="fw-semibold text-sm">Hi, ${firstName}</span>
                            <a href="/api/auth/logout" class="soft-button">Logout</a>
                        </div>
                    `;
                    userAuthSection.innerHTML = loggedInHTML;
                } else {
                    const loggedOutHTML = `<a href="/api/auth/login" class="soft-button">Login</a>`;
                    userAuthSection.innerHTML = loggedOutHTML;
                }
            }

            function updatePricingUI() {
                if (!currentUser) return; 
                const freePlanCard = document.getElementById('free-plan-card');
                const proPlanCard = document.getElementById('pro-plan-card');
                const freePlanButton = document.getElementById('free-plan-button');
                const proPlanButton = document.getElementById('pro-plan-button');
                
                if (currentUser.plan === 'pro') {
                    proPlanButton.textContent = 'Your Current Plan';
                    proPlanButton.disabled = true;
                    proPlanButton.classList.add('bg-secondary', 'disabled');
                    proPlanCard.classList.add('border-success', 'border-3');
                    freePlanButton.textContent = 'Downgrade';
                    freePlanButton.disabled = false;
                    freePlanButton.classList.remove('bg-secondary', 'disabled');
                    freePlanCard.classList.add('opacity-75');
                } else {
                    freePlanButton.textContent = 'Your Current Plan';
                    freePlanButton.disabled = true;
                    freePlanButton.classList.add('bg-secondary', 'disabled');
                    proPlanCard.classList.remove('border-success', 'border-3');
                    freePlanCard.classList.remove('opacity-75');
                }
            }

            function initializeFeatures() {
                let finalPrompt = baseSystemPrompt + healthRule;
                if (currentUser && currentUser.plan === 'pro') {
                    imageGenerationLimit = 20;
                    chatInput.removeAttribute('maxlength');
                    charCounter.textContent = 'Unlimited';
                } else {
                    finalPrompt += proUpgradeMessage;
                    imageGenerationLimit = 5;
                    chatInput.setAttribute('maxlength', '5000');
                    charCounter.textContent = `${chatInput.value.length} / 5000`; 
                }
                systemPrompt = finalPrompt;
                
                if (!currentUser) {
                    chatInput.disabled = true;
                    sendButton.disabled = true;
                    uploadImageButton.disabled = true;
                    generateImageButton.disabled = true;
                    chatInput.placeholder = "Please log in to start your chat with Alara...";
                    loginCta.classList.remove('d-none');
                    loginCta.classList.add('d-flex');
                    chatBox.classList.add('d-none');
                    charCounter.textContent = ''; 
                } else {
                    chatInput.disabled = false;
                    sendButton.disabled = false;
                    uploadImageButton.disabled = false;
                    generateImageButton.disabled = false;
                    chatInput.placeholder = "Type your message or image prompt...";
                    loginCta.classList.add('d-none');
                    loginCta.classList.remove('d-flex');
                    chatBox.classList.remove('d-none');
                }
            }

            // Check for URL parameters that indicate OAuth return
            function checkForOAuthReturn() {
                const urlParams = new URLSearchParams(window.location.search);
                const hasAuthParams = urlParams.has('code') || urlParams.has('state') || urlParams.has('error');
                
                if (hasAuthParams) {
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname + window.location.hash);
                    // Force auth check
                    return true;
                }
                return false;
            }

            function runTypingAnimation() {
                if (!heroTitle) return;
                const currentHash = window.location.hash || '#home';
                if (currentHash === '#home') { 
                    if (currentHeroCharIndex < heroText.length) {
                        heroTitle.innerHTML = heroText.substring(0, currentHeroCharIndex + 1) + '<span class="typing-cursor"></span>';
                        currentHeroCharIndex++;
                        typingAnimationTimeout = setTimeout(runTypingAnimation, 50); 
                    } else {
                        heroTitle.innerHTML = heroText + '<span class="typing-cursor"></span>';
                    }
                }
            }

            function stopTypingAnimation() {
                if (typingAnimationTimeout) {
                    clearTimeout(typingAnimationTimeout);
                    typingAnimationTimeout = null;
                }
                if (heroTitle) heroTitle.innerHTML = heroText;
                currentHeroCharIndex = 0;
            }

            function showSection(targetHash) {
                if (!targetHash) targetHash = '#home';
                document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
                const targetSection = document.querySelector(targetHash);
                if(targetSection) {
                    targetSection.classList.add('active');
                }
                
                if (window.location.hash !== targetHash) {
                    window.history.pushState(null, '', targetHash);
                }
                const mobileMenuInstance = new bootstrap.Collapse(mobileMenu, { toggle: false });
                mobileMenuInstance.hide();
            }
            
            function postProcessMessageBubble(bubble) {
                const codeBlocks = bubble.querySelectorAll('pre');
                codeBlocks.forEach(pre => {
                    if (pre.querySelector('.copy-code-button')) return;
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-code-button';
                    copyButton.innerHTML = `<svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg> <span>Copy</span>`;
                    pre.appendChild(copyButton);
                });
                
                Prism.highlightAllUnder(bubble);
                
                renderMathInElement(bubble, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }

            function addMessage(message, sender = 'ai', options = {}) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-message d-flex ${sender === 'user' ? 'justify-content-end' : ''} ${sender === 'system' ? 'justify-content-center' : ''}`;
                
                const bubble = document.createElement('div');
                bubble.className = `position-relative p-3 rounded-4 mw-80 ${sender}-bubble`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                if (message) {
                    contentDiv.innerHTML = marked.parse(message);
                }

                if (options.imageUrl) {
                    const imageElement = document.createElement('img');
                    imageElement.src = options.imageUrl;
                    imageElement.alt = options.imageAlt || 'Generated image';
                    imageElement.className = 'mt-2 rounded-3 img-fluid';
                    contentDiv.appendChild(imageElement);
                }

                bubble.appendChild(contentDiv);

                // Fixed PDF button visibility and positioning
                if (sender === 'ai' && message) {
                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'message-actions';
                    
                    const pdfButton = document.createElement('button');
                    pdfButton.className = 'pdf-button btn btn-light btn-sm rounded-circle shadow-sm';
                    pdfButton.title = 'Download as PDF';
                    pdfButton.innerHTML = `<svg style="height: 1rem; width: 1rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>`;
                    actionsContainer.appendChild(pdfButton);
                    
                    bubble.appendChild(actionsContainer);
                }

                wrapper.appendChild(bubble);
                chatBox.appendChild(wrapper);
                chatBox.scrollTop = chatBox.scrollHeight;
                return bubble;
            }

            function typeOutResponse(bubble, text) {
                const contentDiv = bubble.querySelector('.message-content');
                let i = 0;
                contentDiv.innerHTML = "";
                
                const typingIntervalSpeed = 5;
                const typingInterval = setInterval(() => {
                    if (i < text.length) {
                        contentDiv.innerHTML = marked.parse(text.substring(0, i + 1) + '<span class="typing-cursor"></span>');
                        chatBox.scrollTop = chatBox.scrollHeight;
                        i++;
                    } else {
                        clearInterval(typingInterval);
                        contentDiv.innerHTML = marked.parse(text);
                        postProcessMessageBubble(bubble);
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }, typingIntervalSpeed);
            }

            function showTypingIndicator() {
                const typingIndicator = document.createElement('div');
                typingIndicator.id = 'typing-indicator';
                typingIndicator.className = 'chat-message d-flex';
                typingIndicator.innerHTML = `<div class="p-3 rounded-4 ai-bubble ai-typing-indicator"><span class="d-inline-block rounded-circle me-1" style="width: .5rem; height: .5rem; background-color: var(--primary-accent); animation-delay: 0s;"></span><span class="d-inline-block rounded-circle me-1" style="width: .5rem; height: .5rem; background-color: var(--primary-accent); animation-delay: 0.2s;"></span><span class="d-inline-block rounded-circle" style="width: .5rem; height: .5rem; background-color: var(--primary-accent); animation-delay: 0.4s;"></span></div>`;
                chatBox.appendChild(typingIndicator);
                chatBox.scrollTop = chatBox.scrollHeight;
                return typingIndicator;
            }

            async function getAIResponse(history) {
                abortController = new AbortController();
                const signal = abortController.signal;
                const payload = { 
                    contents: history, 
                    systemInstruction: { 
                        parts: [{ text: systemPrompt }] 
                    } 
                };
                
                const apiUrl = new URL('/api/generate', window.location.origin).toString();
                const fetchOptions = { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload), 
                    signal,
                    credentials: 'include'
                };
                
                const response = await fetch(apiUrl, fetchOptions);
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                return await response.json();
            }

            // Check image generation rate limit
            function checkImageGenerationLimit() {
                const now = Date.now();
                if (now - imageGenerationResetTime > 3600000) { // 1 hour = 3600000ms
                    imageGenerationCount = 0;
                    imageGenerationResetTime = now;
                }
                return imageGenerationCount < imageGenerationLimit;
            }

            // Image generation function connected to your API
            async function generateImage() {
                if (!currentUser) {
                    addMessage("Please log in to generate images.", 'system');
                    return;
                }

                if (!checkImageGenerationLimit()) {
                    const timeLeft = Math.ceil((3600000 - (Date.now() - imageGenerationResetTime)) / 60000);
                    addMessage(`Image generation limit reached. Please wait ${timeLeft} minutes or upgrade to Pro for more generations.`, 'system');
                    return;
                }

                const prompt = chatInput.value.trim();
                if (!prompt) {
                    addMessage("Please enter a description for the image you'd like to generate.", 'system');
                    return;
                }

                // Show generating message
                const generatingBubble = addMessage(`Generating image: "${prompt}"`, 'ai');
                const generateButton = generateImageButton;
                const originalButtonHTML = generateButton.innerHTML;
                generateButton.innerHTML = `<div class="image-generating">Generating...</div>`;
                generateButton.disabled = true;

                chatInput.value = '';
                chatInput.dispatchEvent(new Event('input'));

                try {
                    const response = await fetch('/api/imagine', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt }),
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to generate image: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    // Remove generating message
                    generatingBubble.remove();

                    if (result.imageUrl) {
                        // Add image to chat
                        addMessage(`Here's your generated image:`, 'ai', { 
                            imageUrl: result.imageUrl, 
                            imageAlt: `Generated image: ${prompt}` 
                        });

                        // Update chat history
                        const currentChat = allChats.find(c => c.id === currentChatId);
                        if (currentChat) {
                            currentChat.history.push({ 
                                role: "user", 
                                parts: [{ text: `Generate image: ${prompt}` }] 
                            });
                            currentChat.history.push({ 
                                role: "model", 
                                parts: [{ text: `Image generated: ${result.imageUrl}` }] 
                            });
                            saveAllChats();
                        }

                        imageGenerationCount++;
                    } else {
                        addMessage("Sorry, I couldn't generate the image. Please try again with a different prompt.", 'ai');
                    }

                } catch (error) {
                    console.error('Image generation error:', error);
                    generatingBubble.remove();
                    addMessage("There was an error generating your image. Please try again later.", 'ai');
                } finally {
                    generateButton.innerHTML = originalButtonHTML;
                    generateButton.disabled = false;
                }
            }

            async function handleSendMessage(event) {
                if (event) event.preventDefault();
                if (isAwaitingResponse) return;
                if (!currentUser) {
                    addMessage("Please log in to send a message.", 'system');
                    return;
                }
                const message = chatInput.value.trim();
                if (!message && !attachedFile) return;

                isAwaitingResponse = true;
                updateSendButtonUI(true);

                addMessage(attachedFile ? `[Image Attached] ${message}` : message, 'user');
                chatInput.value = '';
                chatInput.dispatchEvent(new Event('input'));
                const typingIndicator = showTypingIndicator();
                
                const currentChat = allChats.find(c => c.id === currentChatId);
                const userParts = [];
                if (message) userParts.push({ text: message });
                if (attachedFile) userParts.push({ inlineData: { mimeType: attachedFile.mimeType, data: attachedFile.base64Data } });
                currentChat.history.push({ role: "user", parts: userParts });
                saveAllChats();
                clearAttachment();
                
                try {
                    const result = await getAIResponse(currentChat.history);
                    typingIndicator.remove();
                    if (result.candidates && result.candidates.length > 0) {
                        const aiResponse = result.candidates[0].content.parts[0].text;
                        const aiBubble = addMessage("", 'ai');
                        typeOutResponse(aiBubble, aiResponse);
                        currentChat.history.push({ role: "model", parts: [{ text: aiResponse }] });
                        if(currentChat.title === "New Chat" && message) {
                            currentChat.title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                            renderChatHistorySidebar();
                        }
                        saveAllChats();
                    } else {
                        addMessage("I'm having a little trouble thinking right now. Could you try asking again?", 'ai');
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error("Error fetching AI response:", error);
                        if (error.message.includes('401')) {
                            addMessage("Your session has expired. Please log in again.", 'system');
                            currentUser = null;
                            initializeFeatures();
                        } else {
                            addMessage("Oh no! Something went wrong with my circuits. Please give me a moment and try again.", 'ai');
                        }
                    }
                    typingIndicator.remove();
                } finally {
                    isAwaitingResponse = false;
                    updateSendButtonUI(false);
                }
            }

            function updateSendButtonUI(isThinking) {
                 if (isThinking) {
                    sendButton.innerHTML = `<svg class="h-6 w-6" style="width: 1.5rem; height: 1.5rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
                    sendButton.setAttribute('aria-label', 'Stop generating');
                } else {
                    sendButton.innerHTML = `<svg class="h-6 w-6" style="width: 1.5rem; height: 1.5rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>`;
                    sendButton.setAttribute('aria-label', 'Send message');
                }
            }

            // Event Listeners & UI Handlers
            sendButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (isAwaitingResponse) {
                    abortController.abort();
                } else {
                    handleSendMessage(e);
                }
            });
            
            chatInput.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    if (!isAwaitingResponse) {
                       handleSendMessage(e);
                    }
                } 
            });
            
            navLinks.forEach(l => l.addEventListener('click', (e) => { e.preventDefault(); showSection(l.getAttribute('href')); }));
            mobileMenuButton.addEventListener('click', () => {
                 const mobileMenuInstance = new bootstrap.Collapse(mobileMenu, { toggle: true });
            });
             if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
            }
            closeSidebarButton.addEventListener('click', () => sidebar.classList.remove('open'));
            
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = `${chatInput.scrollHeight}px`;
                 if (currentUser && currentUser.plan === 'pro') {
                    charCounter.textContent = 'Unlimited';
                } else if (!currentUser) {
                    charCounter.textContent = '';
                } else {
                    charCounter.textContent = `${chatInput.value.length} / 5000`;
                }
            });
            
            uploadImageButton.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    attachedFile = { base64Data: reader.result.split(',')[1], mimeType: file.type, name: file.name };
                    renderImagePreview();
                };
                reader.readAsDataURL(file);
            });

            function renderImagePreview() {
                if (!attachedFile) return;
                imagePreviewContainer.innerHTML = `
                    <div class="position-relative d-inline-block mb-2">
                        <img src="data:${attachedFile.mimeType};base64,${attachedFile.base64Data}" 
                             class="rounded-3 border" 
                             style="width: 80px; height: 80px; object-fit: cover;">
                        <button id="remove-image-btn" 
                                class="position-absolute top-0 start-100 translate-middle btn btn-danger btn-sm rounded-circle p-1" 
                                style="width: 24px; height: 24px; font-size: 12px; line-height: 1;"
                                title="Remove image">&times;</button>
                    </div>
                `;
                document.getElementById('remove-image-btn').addEventListener('click', clearAttachment);
            }

            function clearAttachment() {
                attachedFile = null;
                imagePreviewContainer.innerHTML = '';
                imageInput.value = '';
            }

            // Event delegation for dynamic buttons
            chatBox.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const messageBubble = target.closest('.chat-message > div');
                if (!messageBubble) return;

                if (target.matches('.pdf-button, .pdf-button *')) {
                    const contentElement = messageBubble.querySelector('.message-content');
                    contentElement.classList.add('pdf-render-scale');

                    const doc = new jsPDF();
                    
                    doc.html(contentElement, {
                        callback: function (doc) {
                            contentElement.classList.remove('pdf-render-scale');
                            doc.save('alara-response.pdf');
                        },
                        margin: [15, 15, 15, 15],
                        autoPaging: 'text',
                        width: 180,
                        windowWidth: 750,
                        html2canvas: {
                            scale: 2,
                            useCORS: true,
                            letterRendering: true
                        }
                    });
                } else if (target.matches('.copy-code-button, .copy-code-button *')) {
                    const codeBlock = target.closest('pre')?.querySelector('code');
                    if (codeBlock) {
                        navigator.clipboard.writeText(codeBlock.innerText).then(() => {
                            const button = target.closest('.copy-code-button');
                            const originalHTML = button.innerHTML;
                            button.innerHTML = `<svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg> <span>Copied!</span>`;
                            button.classList.add('copied');
                            setTimeout(() => {
                                button.innerHTML = originalHTML;
                                button.classList.remove('copied');
                            }, 2000);
                        }).catch(err => console.error('Failed to copy text:', err));
                    }
                } 
            });

            generateImageButton.addEventListener('click', generateImage);

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                const isDark = document.body.classList.contains('dark');
                localStorage.setItem('alaraTheme', isDark ? 'dark' : 'light');
                updateThemeIcons(isDark);
            });

            function updateThemeIcons(isDark) {
                themeIconLight.classList.toggle('d-none', isDark);
                themeIconDark.classList.toggle('d-none', !isDark);
            }
            
            function saveAllChats() {
                try { localStorage.setItem('alaraAllChats', JSON.stringify(allChats)); } catch (e) { console.error("Could not save chat history:", e); }
            }

            function loadAllChats() {
                try {
                    const savedChats = localStorage.getItem('alaraAllChats');
                    allChats = savedChats ? JSON.parse(savedChats) : [];
                } catch (e) {
                    console.error("Could not parse chat history:", e);
                    allChats = [];
                }
            }
            
            function loadChat(chatId) {
                const chat = allChats.find(c => c.id === chatId);
                if (!chat) {
                    if (allChats.length > 0) {
                        loadChat(allChats[0].id)
                    } else {
                        startNewChat();
                    }
                    return;
                };
                currentChatId = chat.id;
                chatBox.innerHTML = '';
                chat.history.forEach(msg => {
                    const textPart = msg.parts.find(p => p.text)?.text || '';
                    const imageMatch = textPart.match(/^Image generated: (https:\/\/[^\s]+)$/);
                    if (imageMatch && msg.role === 'model') {
                        addMessage(`Here's your image:`, 'ai', { imageUrl: imageMatch[1], imageAlt: 'Generated image' });
                    } else {
                        const bubble = addMessage(textPart, msg.role === 'model' ? 'ai' : 'user');
                        if (msg.role === 'model') {
                            postProcessMessageBubble(bubble);
                        }
                    }
                });
                sidebar.classList.remove('open');
                renderChatHistorySidebar();
            }

            function startNewChat() {
                const newChat = { id: Date.now().toString(), title: "New Chat", history: [] };
                allChats.unshift(newChat);
                currentChatId = newChat.id;
                saveAllChats();
                loadChat(currentChatId);
            }
            
            newChatButton.addEventListener('click', startNewChat);

            function renderChatHistorySidebar() {
                chatHistoryList.innerHTML = '';
                
                allChats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'p-2 mb-1 rounded d-flex justify-content-between align-items-center';
                    item.style.cursor = 'pointer';
                    
                    if (chat.id === currentChatId) {
                        item.style.backgroundColor = 'var(--secondary-accent)';
                        item.style.opacity = '0.7';
                    }
                    
                    item.addEventListener('mouseenter', () => {
                        if (chat.id !== currentChatId) {
                            item.style.backgroundColor = 'var(--secondary-accent)';
                            item.style.opacity = '0.5';
                        }
                    });
                    
                    item.addEventListener('mouseleave', () => {
                        if (chat.id !== currentChatId) {
                            item.style.backgroundColor = '';
                            item.style.opacity = '';
                        }
                    });
                    
                    item.innerHTML = `
                        <span class="text-truncate pe-2 flex-fill" style="font-size: 0.9rem;">${chat.title}</span>
                        <div class="d-flex align-items-center gap-1 flex-shrink-0">
                            <button class="rename-btn btn btn-sm p-1" 
                                    style="width: 28px; height: 28px; background: none; border: none; color: var(--text-color);" 
                                    title="Rename chat">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                    <path d="m15 5 4 4"/>
                                </svg>
                            </button>
                            <button class="delete-btn btn btn-sm p-1" 
                                    style="width: 28px; height: 28px; background: none; border: none; color: #dc3545;" 
                                    title="Delete chat">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"/>
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                    <line x1="10" x2="10" y1="11" y2="17"/>
                                    <line x1="14" x2="14" y1="11" y2="17"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    // Add hover effects for buttons
                    const renameBtn = item.querySelector('.rename-btn');
                    const deleteBtn = item.querySelector('.delete-btn');
                    
                    renameBtn.addEventListener('mouseenter', () => {
                        renameBtn.style.backgroundColor = 'var(--secondary-accent)';
                        renameBtn.style.borderRadius = '4px';
                    });
                    
                    renameBtn.addEventListener('mouseleave', () => {
                        renameBtn.style.backgroundColor = '';
                    });
                    
                    deleteBtn.addEventListener('mouseenter', () => {
                        deleteBtn.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                        deleteBtn.style.borderRadius = '4px';
                    });
                    
                    deleteBtn.addEventListener('mouseleave', () => {
                        deleteBtn.style.backgroundColor = '';
                    });
                    
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            loadChat(chat.id);
                        }
                    });
                    
                    renameBtn.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        renameChat(chat.id); 
                    });
                    
                    deleteBtn.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        deleteChat(chat.id); 
                    });
                    
                    chatHistoryList.appendChild(item);
                });
            }
            
            function renameChat(chatId) {
                const chat = allChats.find(c => c.id === chatId);
                const newTitle = prompt("Enter new chat title:", chat.title);
                if(newTitle && newTitle.trim() !== '') {
                    chat.title = newTitle.trim();
                    saveAllChats();
                    renderChatHistorySidebar();
                }
            }
            
            function deleteChat(chatId) {
                if(confirm("Are you sure you want to delete this chat?")) {
                    allChats = allChats.filter(c => c.id !== chatId);
                    saveAllChats();
                    if(currentChatId === chatId) {
                        currentChatId = null;
                        if(allChats.length > 0) {
                            loadChat(allChats[0].id);
                        } else {
                            startNewChat();
                        }
                    }
                    renderChatHistorySidebar();
                }
            }
            
            function updateActiveNavLinkOnScroll() {
                 const headerOffset = 120;
                 let currentSectionId = sections[0].id;

                sections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    if (rect.top <= headerOffset && rect.bottom >= headerOffset) {
                       currentSectionId = section.id;
                    }
                });

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === `#${currentSectionId}`) {
                        link.classList.add('active');
                    }
                });

                 if (`#${currentSectionId}` === '#home') {
                    if (!typingAnimationTimeout && currentHeroCharIndex === 0) {
                        heroTitle.innerHTML = '';
                        runTypingAnimation();
                    }
                } else {
                    stopTypingAnimation();
                }
            }

            async function initialize() {
                // Theme setup
                const savedTheme = localStorage.getItem('alaraTheme');
                if (savedTheme === 'dark') document.body.classList.add('dark');
                updateThemeIcons(savedTheme === 'dark');
                
                // Navigation setup
                showSection(window.location.hash || '#home');
                
                // Check for OAuth return
                const isOAuthReturn = checkForOAuthReturn();
                
                // Auth check with potential delay for OAuth
                if (isOAuthReturn) {
                    // Wait a bit longer for OAuth processing
                    setTimeout(checkAuthStatus, 1000);
                } else {
                    await checkAuthStatus();
                }
                
                // Chat setup
                loadAllChats();
                if (allChats.length === 0) {
                    startNewChat();
                } else {
                    loadChat(allChats[0].id);
                }
                
                updateSendButtonUI(false);
                
                // Scroll handler
                let scrollTimeout;
                window.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(updateActiveNavLinkOnScroll, 50);
                });
                
                setTimeout(updateActiveNavLinkOnScroll, 100);
                
                // Listen for storage events (for multi-tab auth sync)
                window.addEventListener('storage', (e) => {
                    if (e.key === 'alara_auth_change') {
                        checkAuthStatus();
                    }
                });
                
                // Periodic auth check
                setInterval(() => {
                    if (!authCheckInProgress) {
                        checkAuthStatus();
                    }
                }, 30000); // Check every 30 seconds
            }

            // Handle browser back/forward navigation
            window.addEventListener('popstate', () => {
                showSection(window.location.hash || '#home');
            });

            initialize();
        });
    </script>
</body>
</html>
